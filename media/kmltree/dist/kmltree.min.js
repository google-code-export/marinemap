(function(){var v={};this.tmpl=function n(o,z){o=!/\W/.test(o)?(v[o]=v[o]||n(document.getElementById(o).innerHTML)):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+o.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return z?o(z):o}})();
kmldom=function(){return function(v){if(window.ActiveXObject&&window.GetObject){var n=new ActiveXObject("Microsoft.XMLDOM");n.loadXML(v);return jQuery(n)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(v,"text/xml"));throw new Error("No XML parser available");}}();
var kmltree=function(){function v(d){var e=document.createElement("a");e.href=d;return e.href}openBalloon=function(d,e){var l=e.createFeatureBalloon("");l.setFeature(d);l.setMinWidth(100);e.setBalloon(l)};var n=function(d){if(d.success&&d.error&&d.tree&&d.my){this.queue=[];this.opts=d}else throw"missing required option";};n.prototype.add=function(d,e){this.queue.push({node:d,callback:e,loaded:false,errors:false})};n.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var d=
0;d<this.queue.length;d++){var e=this.queue[d];e.node.data("queueItem",e);if(!e.loaded&&!e.loading){var l=this;$(e.node).bind("loaded",function(p,q,F){l.nodeLoadedCallback(p,q,F)});this.opts.tree.openNetworkLink(e.node);e.loading=true}}};n.prototype.nodeLoadedCallback=function(d,e){d=e.data("queueItem");if(d.loaded===true)throw"event listener fired twice for "+e.find(">span.name").text();d.loaded=true;d.loading=false;$(e).unbind("loaded");d.callback(e);this.finish(d)};n.prototype.finish=function(){for(var d=
true,e=true,l=0;l<this.queue.length;l++){d=d&&this.queue[l].loaded;e=e&&!this.queue[l].errors}if(d){e?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};n.prototype.destroy=function(){for(var d=0;d<this.queue.length;d++)this.queue[d].node.unbind("load");this.queue=[]};var o=tmpl('<li UNSELECTABLE="on" class="<%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %>kmltree-id-<%= id %> kmltree-item"><span class="kmlId"><%= kmlId %></span><span class="nlDocId"></span><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>);"<% } %>class="icon">&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
z={enableSelection:function(){return false},visitFunction:function(d,e){return e},openNetworkLinks:true,refreshWithState:true,bustCache:false,restoreState:false,supportItemIcon:false,loadingMsg:"Loading data",setExtent:false};return function(d){var e={},l=0,p={};e.lookupTable=p;e.kmlObject=null;var q={},F={};d=jQuery.extend({},z,d);var i=d.gex.pluginInstance,J=false;if(parseFloat(i.getPluginVersion())<5.1)throw"kmltree requires a google earth plugin version >= 5.1";if(!d.url||!d.gex||!d.element)throw"kmltree requires options url, gex & element";
if(!d.element.attr("id")){d.element.attr("id","kml-tree"+(new Date).getTime());d.element.attr("UNSELECTABLE","on")}d.restoreState&&$(window).unload(function(){e.destroy()});d.element.css("position")!=="absolute"&&$(d.element).css({position:"relative"});var M=function(a){if(e.kmlObject)throw"KML already loaded";K();var b=v(d.url);if(a||d.bustCache){a=(new Date).getTime();b=b.indexOf("?")===-1?b+"?cachebuster="+a:b+"&cachebuster="+a}google.earth.fetchKml(i,b,function(c){J||L(c,b)})};e.load=M;var A=
function(a){if(a){a=a.replace(/\//g,"-");return d.element.find(".kmltree-id-"+a)}};e.getNodesById=A;e.selectById=function(a){a=A(a)[0];return x(a,m(a))};var t=function(a,b){var c=$("#"+d.element.attr("id")).find(".selected").removeClass("selected");if(c.length){c.each(function(){r($(this),"selected",false)});b||$(e).trigger("select",[null,null])}i.getBalloon()&&!a&&i.setBalloon(null)};e.clearSelection=t;var B=function(a,b,c){if(a&&b&&c){var f=a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded");if(b.name!==
"root"){var g=b.modified;if(g){var h=false;if(g.open!==undefined)if(f)if(g.open.current){h=true;c.add(a,function(j){B(j,b,c);c.execute()})}else{if(a.hasClass("open")){a.removeClass("open");r(a,"open",false)}}else{a.toggleClass("open",g.open.current);r(a,"open",g.open.current)}if(g.visibility!==undefined)if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&g.visibility.current&&!h&&!a.hasClass("loading")&&!a.hasClass("loaded")){C(a);$(a).bind("loaded",function(j,N){w(N,true);N.removeClass("open")})}else s(a,
g.visibility.current);g.selected!==undefined&&x(a,m(a))}}else a.find(".KmlNetworkLink.open").removeClass("open");if(!f)for(f=0;f<b.children.length;f++){var k=b.children[f];g=a.find(">ul>li>span.name:contains("+k.name+")").parent();if(g.length===1)B(g,k,c);else g.length>1&&g.each(function(){$(this).find(">span.name").text()===k.name&&B($(this),k,c)})}}else throw"called with invalid arguments";},K=function(a){D();a=a||d.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var b=d.element.height();
b!==0&&a.height(b);d.element.append(a)};e.showLoading=K;var D=function(){d.element.find(".kmltree-loading").remove()};e.hideLoading=D;var L=function(a,b){if(a){l=0;e.kmlObject=a;e.kmlObject.setVisibility(true);var c=O(a),f=E(c.children[0].children);d.element.find("div.kmltree").remove();d.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',c.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',f,"</ul></div>"].join(""));
i.getFeatures().appendChild(a);c=new n({success:function(){D();if(d.setExtent){var g=null,h=$(d.map_div);if(h.length)g=h.width()/h.height();d.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:g});d.setExtent=false}$(e).trigger("kmlLoaded",[a])},error:function(){D();$(e).trigger("kmlLoadError",[a])},tree:e,my:F});if(!e.previousState)if(d.restoreState&&window.localStorage)e.previousState=W();e.previousState&&e.previousState.children.length?B(d.element.find("div.kmltree"),e.previousState,c):P(c,
$("#"+d.element.attr("id")));c.execute()}else if(l===0){l++;setTimeout(function(){jQuery.ajax({url:b,success:function(){e.load(true)},error:function(){L(a,b)}})},100)}else setTimeout(function(){d.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(e).trigger("kmlLoadError",[a])},0)},P=function(a,b){b.find("li.KmlNetworkLink.open").each(function(){if(!$(this).hasClass("checkHideChildren")){var c=
$(this);c.removeClass("open");a.add(c,function(f){f.addClass("open");r(f,"open",c.hasClass("open"));P(a,f);a.execute()})}})},O=function(a){var b=X(a),c={name:a.getName()};google.earth.executeBatch(i,function(){d.gex.dom.walk({visitCallback:function(f){var g=f.current;if(!g.children)g.children=[];var h=Y(b,this),k=this.getSnippet();if(!k||k==="empty")k=false;h={renderOptions:E,name:this.getName()||"&nbsp;",visible:!!this.getVisibility(),type:this.getType(),open:this.getOpen(),id:this.getId().replace(/\//g,
"-"),description:this.getDescription(),snippet:k,select:d.enableSelection(this),listItemType:Z(this),customIcon:aa(this),customClass:"",children:[],kmlId:h,alwaysRenderNodes:false};h=d.visitFunction(this,h);g.children.push(h);if(h.listItemType!=="checkHideChildren")f.child=h;else f.walkChildren=false},rootObject:a,rootContext:c})});return c},aa=function(a){if(!d.supportItemIcon)return false;return(a=kmldom(a.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?
a:false},Z=function(a){var b="check";if((a=a.getStyleSelector())&&a.getType()==="KmlStyle")if(a=a.getListStyle())switch(a.getListItemType()){case 0:break;case 5:b="radioFolder";break;case 2:b="checkOffOnly";break;case 3:b="checkHideChildren";break}return b},E=function(a){if(jQuery.isArray(a)){for(var b=[],c=0;c<a.length;c++)b.push(Q(a[c]));return b.join("")}else return Q(a)},ba={renderOptions:E},Q=function(a){return o(jQuery.extend({},ba,a))},R=function(){p=null;p={}};e.refresh=function(){if(d.refreshWithState)e.previousState=
G();R();S();T();i.setBalloon(null);M(true)};var T=function(){for(var a in q){var b=q[a];b&&b.getParentNode()&&d.gex.dom.removeObject(b)}q={}},S=function(){T();e.kmlObject&&e.kmlObject.getParentNode()&&d.gex.dom.removeObject(e.kmlObject);e.kmlObject=null},W=function(){var a=localStorage.getItem("kmltree-("+d.url+")");return a?JSON.parse(a):false},ca=function(){var a=JSON.stringify(G());localStorage.setItem("kmltree-("+d.url+")",a)};e.destroy=function(){J=true;d.restoreState&&window.localStorage&&ca();
R();S();var a=d.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();d.element.html("")};var m=function(a){a=$(a);if(a.length&&a.find("> .kmlId").length){var b=$($(a)[0]).find("> .kmlId").text().split("-");a=b[0];b=parseInt(b[1]);return p[a][b]}else return false};e.lookup=m;var Y=function(a,b){p[a].push(b);return a+"-"+(p[a].length-1)},U=function(a){a=$(a);return a.length&&a.find("> .nlDocId").length?q[a.find("> .nlDocId").text()]:false},X=function(a){var b=
a.getName()+(new Date).getTime();if(p[b])throw"document already added to lookup";q[b]=a;p[b]=[];return b},x=function(a,b){b||(b=m(a));a=$(a);t(true,true);a.addClass("selected");w(a,true);a.addClass("selected");openBalloon(b,i);for(var c=a.parent().parent();!c.hasClass("kmltree")&&!c.find(">ul:visible").length;){c.addClass("open");c=c.parent().parent()}r(a,"selected",true);$(e).trigger("select",[a,b])};e.selectNode=x;var y=function(a,b){if(b){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){a=
a.find(">ul>li");if(a.length){s($(a[0]),true);y($(a[0]),true)}}}else a.find(">ul>li").each(function(){var c=$(this);if(!c.hasClass("checkOffOnly")){s(c,true);y(c,true)}})}else a.find("li").each(function(){s($(this),false)})},H=function(a,b){var c=a.parent().parent();if(!c.hasClass("kmltree"))if(b){a=c.parent().parent();a.hasClass("radioFolder")&&a.find(">ul>li.visible").each(function(){if(this!==c[0]){var f=$(this);s(f,false);y(f,false)}});if(!c.hasClass("visible")){s(c,true);H(c,true)}}else if(c.find(">ul>li.visible").length===
0){s(c,false);H(c,false)}},w=function(a,b){if(!(a.hasClass("checkOffOnly")&&b)){var c=a.parent().parent();c.hasClass("radioFolder")&&c.find(">ul>li.visible").each(function(){s($(this),false);y($(this),false)});s(a,b);y(a,b);H(a,b)}},s=function(a,b){a=$(a);if(a.hasClass("visible")!==b){r(a,"visibility",b);m(a);m(a).setVisibility(b);a.toggleClass("visible",b);a.hasClass("KmlNetworkLink")&&a.hasClass("loaded")&&U(a).setVisibility(b)}},r=function(a,b,c){var f=a.data("modified");f||(f={});if(!f[b]){f[b]=
{};f[b].original=b==="open"?m(a).getOpen():b==="visibility"?m(a).getVisibility():!c}f[b].current=c;a.data("modified",f)},G=function(){var a={name:"root",remove:false,children:[],parent:false};V(function(c,f){var g={name:c.find(">span.name").text(),remove:true,children:[],parent:f};c=c.data("modified");var h={},k=false;for(var j in c)if(c[j].current!==c[j].original){h[j]=c[j];k=j}if(k){g.modified=h;g.remove=false;for(j=f;j.parent;){j.remove=false;j=j.parent}}f.children.push(g);return g},a);var b=function(c){if(c.remove===
true)return false;else{for(var f=[],g=0;g<c.children.length;g++){var h=b(c.children[g]);if(h){delete h.remove;delete h.parent;f.push(h)}}c.children=f;return c}};return b(a)};e.getState=G;var da=function(a){for(var b in q)if(q[b]===a)return b;throw"could not getDocId";},C=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var b=m(a),c=b.getLink();if(c){c=c.getHref();if(d.bustCache){var f=(new Date).getTime();c=c.indexOf("?")===-1?c+"?cachebuster="+f:c+"&cachebuster="+f}a.addClass("loading");
google.earth.fetchKml(i,c,function(g){if(g){i.getFeatures().appendChild(g);g.setVisibility(b.getVisibility());b.getParentNode().getFeatures().removeChild(b);var h=O(g);h=E(h.children[0].children);a.append("<ul>"+h+"</ul>");a.addClass("open");r(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");a.find(".nlDocId").text(da(g));$(a).trigger("loaded",[a,g]);$(e).trigger("networklinkload",[a,g])}else{alert("Error loading "+c);a.addClass("error");$(e).trigger("kmlLoadError",[g]);
a.removeClass("open")}})}else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");r(a,"open",false)}}};e.openNetworkLink=C;var V=function(a,b,c){var f=function(g,h){g.find(">ul>li").each(function(){var k=$(this),j=a(k,h);if(j===false)return true;else f(k,j)})};c||(c=d.element.find("div.kmltree"));f(c,b)};e.walk=V;var u=d.element.attr("id");$("#"+u+" li > span.name").live("click",function(){var a=$(this).parent(),b=m(a);if(a.hasClass("error")&&a.hasClass("KmlNetworkLink"))b.getLink()&&
b.getLink().getHref()?alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");if(a.hasClass("select"))x(a,b);else{t();if(a.hasClass("hasDescription")||b.getType()==="KmlPlacemark"){b.getType()==="KmlPlacemark"&&w(a,true);openBalloon(b,i,d.whiteListed)}}$(e).trigger("click",[a[0],b])});$("#"+u+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),b=m(a);$(e).trigger("contextmenu",[a[0],b])});d.element.click(function(a){if(a.target===
this)t();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&t()}});$("#"+u+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))C(a);else{a.toggleClass("open");r(a,"open",a.hasClass("open"))}});$("#"+u+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");!b&&a.hasClass("selected")&&t();!b&&i.getBalloon()&&i.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&
b)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){C(a);$(a).bind("loaded",function(c,f){w(f,true);f.removeClass("open")})}else w(a,b);$(e).trigger("toggleItem",[a,b])}});$("#"+u+" li").live("dblclick",function(a){a=$(a.target);var b=a.parent();if(!(a.hasClass("expander")||a.hasClass("toggler")||b.hasClass("expander")||b.hasClass("toggler"))){a=$(this);b=m(a);if(a.hasClass("error"))b.getLink()&&b.getLink().getHref()?
alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{w(a,true);if(b.getType()=="KmlTour")i.getTourPlayer().setTour(b);else{var c=null,f=$(d.map_div);if(f.length)c=f.width()/f.height();b.getType()==="KmlNetworkLink"&&a.hasClass("loaded")?d.gex.util.flyToObject(U(a),{boundsFallback:true,aspectRatio:c}):d.gex.util.flyToObject(b,{boundsFallback:true,aspectRatio:c})}$(e).trigger("dblclick",[a,b])}}});u=google.earth.addEventListener;
u(i.getGlobe(),"click",function(a){if(a.getButton()!==-1){a=a.getTarget();var b=i.getBalloon();if(a.getType()==="GEGlobe"&&!b)t();else if(a.getType()==="KmlPlacemark"){a=a.getId();a=A(a);a.length>=1?x(a[0],m(a[0])):t()}}});var I=false;u(i.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe")if(b.getType()==="KmlPlacemark"){a=b.getId();var c=A(a);if(c.length>=1)if(!I){I=true;setTimeout(function(){I=false;var f=$(c[0]);$(e).trigger("dblclick",[f,b])},
200)}}}});return e}}();
