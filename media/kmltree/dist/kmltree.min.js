var kmltreeManager=function(){function g(a){e=a;google.earth.addEventListener(e,"balloonopening",h);google.earth.addEventListener(e,"balloonclose",j);google.earth.addEventListener(e.getGlobe(),"click",function(a){if(a.getButton()!==-1&&a.getTarget().getType()==="GEGlobe"&&$(".kmltree-selected").length)for(a=0;a<c.length;a++){var b=$(c[a].api.opts.element);b.find(".kmltree-selected").length+b.find(".kmltree-breadcrumb").length>0&&c[a].instance.clearSelection()}})}that={};var c=[],e,b={};that.register=
function(a,b){c.length===0&&g(b.opts.gex.pluginInstance);c.push({key:"kmltree-tree-"+c.length.toString(),instance:a,api:b})};that.remove=function(a){for(var f=0;f<c.length;f++)if(c[f].instance===a){c.splice(f,1);break}for(var h in b)b[h].instance===a&&delete b[h];return a};that.pauseListeners=function(a){google.earth.removeEventListener(e,"balloonopening",h);google.earth.removeEventListener(e,"balloonclose",j);a();google.earth.addEventListener(e,"balloonopening",h);google.earth.addEventListener(e,
"balloonclose",j)};var a=function(a){for(var b=0;b<c.length;b++)if(c[b].instance===a)return c[b].api},h=function(a){var b=a.getFeature(),f=v(b);if(f){a.preventDefault();e.setBalloon(null);var a=!1,c=b.getId();if(c)a=f.api.opts.selectable,typeof a==="function"&&(a=a(b));a&&f.instance.selectById(c,b);l(b,f);return!1}},j=function(){$("#kmltree-balloon-iframe").remove();for(var a=0;a<c.length;a++){var b=$(c[a].api.opts.element);b.find(".kmltree-selected").length+b.find(".KmlNetworkLink.kmltree-breadcrumb:not(.loaded)").length===
1&&b.find(".kmltree-cursor-2").length===0&&c[a].instance.clearSelection()}};that._clearEverythingButMe=function(a){for(var b=0;b<c.length;b++)c[b].instance!==a&&($(c[b].api.opts.element).find(".kmltree-selected").length||$(c[b].api.opts.element).find(".kmltree-breadcrumb").length)&&c[b].instance.clearSelection()};var i=function(a,b){if(!a)return!1;if(a.getUrl()===b)return!0;if(f(a.getUrl())===f(b))return!0;if(a.getElementByUrl(b))return!0;if(a.getElementByUrl(f(b)))return!0;return!1},f=function(a){a=
a.split("#")[0];a=a.replace(/cachebuster=\d+/,"");a.indexOf("?")===a.length-1&&(a=a.replace("?",""));return a},v=function(a){var a=a.getUrl(),h=f(a);if(b[h])return b[h];for(var e=0;e<c.length;e++)if(i(c[e].instance.kmlObject,a))return b[h]=c[e],c[e];for(e=0;e<c.length;e++){var j=c[e].instance.docs;window.trees=c;for(var g=0;g<j.length;g++)if(i(j[g],a))return b[h]=c[e],c[e]}return!1};that.getOwner=function(a){return(a=v(a))?a.instance:!1};var l=function(b,f){$(window).unbind("message.kmlTreeIframeEvents");
var c,f=f.instance?f.instance:f,h=f.api?f.api:a(f);c=h.opts.displayEnhancedContent;typeof c==="function"&&(c=c(b));if(c)var j=b.getBalloonHtmlUnsafe(),g=b.getBalloonHtml(),g=$.trim(g.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,"")),g=g!=$.trim(j);if(c&&g){c=e.createHtmlDivBalloon("");var i=document.createElement("iframe");i.setAttribute("src",h.opts.iframeSandbox);i.setAttribute("frameBorder","0");i.setAttribute("id","kmltree-balloon-iframe");g=document.createElement("div");$(g).append(i);
$(i).one("load",function(){$(window).bind("message.kmlTreeIframeEvents",{window:i.contentWindow},function(a){var b=a.originalEvent;if(b.source===a.data.window){var a=e.getBalloon(),f=a.getFeature();if($("#kmltree-balloon-iframe").length&&!(!b.data.match(/width/)&&!b.data.match(/unknownIframeDimensions/)||a.getType()!=="GEHtmlDivBalloon")){var c=v(f),b=JSON.parse(b.data);if(b.unknownIframeDimensions)b=c.api.opts.unknownIframeDimensionsDefault,typeof b==="function"&&(b=b(f));var h=$("#kmltree-balloon-iframe");
a.setMinWidth(b.width);a.setMaxWidth(b.width+b.width*0.1);a.setMinHeight(b.height);a.setMaxHeight(b.height+b.height*0.1);h.height(b.height);h.width(b.width);$(c.instance).trigger("balloonopen",[a,f])}}});this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(j),callback:Base64.encode(h.opts.sandboxedBalloonCallback.toString())}),"*")});c.setContentDiv(g)}else{c=e.createFeatureBalloon("");var l=function(a){google.earth.removeEventListener(e,"balloonopening",l);setTimeout(function(){$(f).trigger("balloonopen",
[a.getBalloon(),a.getFeature()])},1)};google.earth.addEventListener(e,"balloonopening",l)}c.setFeature(b);e.setBalloon(c)};that._openBalloon=l;return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(g){for(var c="",e,b,a,h,j,i,f=0,g=Base64._utf8_encode(g);f<g.length;)e=g.charCodeAt(f++),b=g.charCodeAt(f++),a=g.charCodeAt(f++),h=e>>2,e=(e&3)<<4|b>>4,j=(b&15)<<2|a>>6,i=a&63,isNaN(b)?j=i=64:isNaN(a)&&(i=64),c=c+this._keyStr.charAt(h)+this._keyStr.charAt(e)+
this._keyStr.charAt(j)+this._keyStr.charAt(i);return c},decode:function(g){for(var c="",e,b,a,h,j,i=0,g=g.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<g.length;)e=this._keyStr.indexOf(g.charAt(i++)),b=this._keyStr.indexOf(g.charAt(i++)),h=this._keyStr.indexOf(g.charAt(i++)),j=this._keyStr.indexOf(g.charAt(i++)),e=e<<2|b>>4,b=(b&15)<<4|h>>2,a=(h&3)<<6|j,c+=String.fromCharCode(e),h!=64&&(c+=String.fromCharCode(b)),j!=64&&(c+=String.fromCharCode(a));return c=Base64._utf8_decode(c)},_utf8_encode:function(g){for(var g=
g.replace(/\r\n/g,"\n"),c="",e=0;e<g.length;e++){var b=g.charCodeAt(e);b<128?c+=String.fromCharCode(b):(b>127&&b<2048?c+=String.fromCharCode(b>>6|192):(c+=String.fromCharCode(b>>12|224),c+=String.fromCharCode(b>>6&63|128)),c+=String.fromCharCode(b&63|128))}return c},_utf8_decode:function(g){for(var c="",e=0,b=c1=c2=0;e<g.length;)b=g.charCodeAt(e),b<128?(c+=String.fromCharCode(b),e++):b>191&&b<224?(c2=g.charCodeAt(e+1),c+=String.fromCharCode((b&31)<<6|c2&63),e+=2):(c2=g.charCodeAt(e+1),c3=g.charCodeAt(e+
2),c+=String.fromCharCode((b&15)<<12|(c2&63)<<6|c3&63),e+=3);return c}};
(function(){var g={};this.tmpl=function e(b,a){var h=!/\W/.test(b)?g[b]=g[b]||e(document.getElementById(b).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return a?h(a):h}})();
kmldom=function(){return function(g){if(window.ActiveXObject&&window.GetObject){var c=new ActiveXObject("Microsoft.XMLDOM");c.loadXML(g);return jQuery(c)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(g,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function g(b,a){var c=/^(.*)\//;return b.authority&&!b.path?"/"+a:b.getPath().match(c)[0]+a}function c(b){if(!b)return"";b=b.replace(/\/\.\//g,"/");for(b=b.replace(/\/\.$/,"/");b.match(e);)b=b.replace(e,"/");for(b=b.replace(/\/([^\/]*)\/\.\.$/,"/");b.match(/\/\.\.\//);)b=b.replace(/\/\.\.\//,"/");return b}var e=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(b){b||(b="");var b=b.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/),a=b[1]||null,c=b[2]||null,e=
b[3]||null,g=b[4]||null,f=b[5]||null;this.getScheme=function(){return a};this.setScheme=function(b){a=b};this.getAuthority=function(){return c};this.setAuthority=function(a){c=a};this.getPath=function(){return e};this.setPath=function(a){e=a};this.getQuery=function(){return g};this.setQuery=function(a){g=a};this.getFragment=function(){return f};this.setFragment=function(a){f=a}};URI.prototype.toString=function(){var b="";this.getScheme()&&(b+=this.getScheme()+":");this.getAuthority()&&(b+="//"+this.getAuthority());
this.getPath()&&(b+=this.getPath());this.getQuery()&&(b+="?"+this.getQuery());this.getFragment()&&(b+="#"+this.getFragment());return b};URI.prototype.resolve=function(b){var a=new URI;this.getScheme()?(a.setScheme(this.getScheme()),a.setAuthority(this.getAuthority()),a.setPath(c(this.getPath())),a.setQuery(this.getQuery())):(this.getAuthority()?(a.setAuthority(this.getAuthority()),a.setPath(c(this.getPath())),a.setQuery(this.getQuery())):(this.getPath()?(this.getPath().charAt(0)==="/"?a.setPath(c(this.getPath())):
(a.setPath(g(b,this.getPath())),a.setPath(c(a.getPath()))),a.setQuery(this.getQuery())):(a.setPath(b.getPath()),this.getQuery()?a.setQuery(this.getQuery()):a.setQuery(b.getQuery())),a.setAuthority(b.getAuthority())),a.setScheme(b.getScheme()));a.setFragment(this.getFragment());return a};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(b,a){var c=new URIQuery;if(a)c.separator=
a;c.addStringParams(b);return c};URIQuery.prototype.addStringParams=function(b){for(var b=b.split(this.separator),a,c,e=0;e<b.length;e++)a=b[e].split("=",2),c=a[0].replace(/\+/g," "),a=a[1].replace(/\+/g," "),this.params.hasOwnProperty(c)||(this.params[c]=[]),this.params[c].push(a)};URIQuery.prototype.getParam=function(b){if(this.params.hasOwnProperty(b))return this.params[b][0];return null};URIQuery.prototype.toString=function(){var b=[],a;a=this.params;var c=[],e;for(e in a)a.hasOwnProperty(e)&&
c.push(e);a=c.sort();for(c=0;c<a.length;c++)for(e=0;e<this.params[a[c]].length;e++)b.push(a[c].replace(/ /g,"+")+"="+this.params[a[c]][e].replace(/ /g,"+"));return b.join(this.separator)}})();
var kmltree=function(){function g(a){var b=document.createElement("a");b.href=a;return b.href}var c=function(a){if(a.success&&a.error&&a.tree)this.queue=[],this.opts=a;else throw"missing required option";};c.prototype.add=function(a,b){this.queue.push({node:a,callback:b,loaded:!1,errors:!1})};c.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var a=0;a<this.queue.length;a++){var b=this.queue[a];b.node.data("queueItem",b);if(!b.loaded&&!b.loading){var c=this;$(b.node).bind("loaded",
function(a,b,e){c.nodeLoadedCallback(a,b,e)});this.opts.tree.openNetworkLink(b.node);b.loading=!0}}};c.prototype.nodeLoadedCallback=function(a,b){var c=b.data("queueItem");if(c.loaded===!0)throw"event listener fired twice for "+b.find(">span.name").text();c.loaded=!0;c.loading=!1;$(b).unbind("loaded");c.callback(b);this.execute();this.finish(c)};c.prototype.finish=function(){for(var a=!0,b=!0,c=0;c<this.queue.length;c++)a=a&&this.queue[c].loaded,b=b&&!this.queue[c].errors;a&&(b?this.opts.success(this.queue):
this.opts.error(this.queue),this.destroy())};c.prototype.destroy=function(){for(var a=0;a<this.queue.length;a++)this.queue[a].node.unbind("load");this.queue=[]};var e=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= classname %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
b={refreshWithState:!0,bustCache:!1,restoreState:!1,whitelist:[],supportItemIcon:!1,loadingMsg:"Loading data",setExtent:!1,displayDocumentRoot:"auto",displayEnhancedContent:!1,iframeSandbox:"http://kmltree.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){},selectable:function(){return!1},multipleSelect:!1,classname:function(){return""}};return function(a){function h(d){for(var a=0;a<r.length;a++)if($(r[a].node)[0]===$(d)[0])return a;
return-1}function j(d,a){h(d,a)===-1&&r.push({node:d,kmlObject:a})}function i(d,a){var b=h(d,a);if(b===-1)throw"removeSelectData error";else r.splice(b,1)}var f={},v=0,l={};f.lookupTable=l;f.kmlObject=null;var s=[],a=jQuery.extend({},b,a),k=a.gex.pluginInstance,L=!1,m={},r=[];f.url=a.url;parseFloat(k.getApiVersion())<1.005&&alert("kmltree requires a google earth plugin version >= 1.005");if(!a.url||!a.gex||!a.element||!a.mapElement)throw"kmltree requires options url, gex, mapElement & element";a.element=
$(a.element);a.element.attr("id")||(a.element.attr("id","kml-tree"+(new Date).getTime()),a.element.attr("UNSELECTABLE","on"));a.restoreState&&$(window).unload(function(){f.destroy()});a.element.css("position")!=="absolute"&&$(a.element).css({position:"relative"});var o=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),aa=o[0].style.backgroundSize!==
void 0||o[0].style.MozBackgroundSize!==void 0||o[0].style.oBackgroundSize!==void 0||o[0].style.khtmlBackgroundSize!==void 0||o[0].style.webkitBackgroundSize!==void 0,Q=function(d,b,c){var f={name:d.getName(),id:"kml"+(c?c.replace(/\W/g,"-"):"")+b.replace(/\W/g,"-")};google.earth.executeBatch(k,function(){a.gex.dom.walk({visitCallback:function(d){var b=d.current;if(!b.children)b.children=[];var x=this.getName(),c;c=b.id;key=x?x.replace(/\W/g,"-"):"blank";c+=key;for(var t=0;l[c];)t++,c+=t;l[c]=this;
var f=this.getSnippet();if(!f||f==="empty")f=!1;var t=this.getType(),e=!1;if(t==="KmlPlacemark"){var A=this.getGeometry();A&&(e=A.getType())}var g=this.getComputedStyle(),h=a.selectable;typeof h==="function"&&(h=h(this));var h=h&&this.getId(),x=x||"&nbsp;",A=!!this.getVisibility(),i=this.getOpen(),j=this.getDescription(),k="check";if(g=g.getListStyle())switch(g.getListItemType()){case 5:k="radioFolder";break;case 2:k="checkOffOnly";break;case 3:k="checkHideChildren"}g=k;k=!1;aa&&this.getType()===
"KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint"&&(k=this.getComputedStyle().getIconStyle().getIcon().getHref());a.supportItemIcon&&(k=(k=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?k:!1);c={renderOptions:B,name:x,visible:A,type:t,open:i,id:c,description:j,snippet:f,select:h,listItemType:g,customIcon:k,classname:a.classname(this),children:[],alwaysRenderNodes:!1,kmlId:this.getId().replace(/\W/g,
"-"),geoType:e};b.children.push(c);c.listItemType!=="checkHideChildren"?d.child=c:d.walkChildren=!1},rootObject:d,rootContext:f})});return f},M=function(d){if(f.kmlObject)throw"KML already loaded";R();var b=g(a.url);if(d||a.bustCache)d=(new Date).getTime(),b=b.indexOf("?")===-1?b+"?cachebuster="+d:b+"&cachebuster="+d;google.earth.fetchKml(k,b,function(d){L||S(d,b,a.url)})};f.load=M;f.refresh=function(){if(a.refreshWithState)f.previousState=G();T();l=null;l={};k.setBalloon(null);M(!0)};var F=function(d){return a.element.find("."+
d.replace(/\W/g,"-"))};f.getNodesById=F;f.expandParentsOf=function(d){d=$(d);for(d=d.parent().parent();!d.hasClass("kmltree")&&!d.find(">ul:visible").length;)d.addClass("open"),d=d.parent().parent()};var N=function(d,a,b){d=F(d);if(d.length)return d=$(d[0]),p(!0,!0),w(d,a||n(d),b),!0;else if(d=P(a))if(d=$(d),d.is(":visible"))return p(!0,!0),d.addClass("kmltree-breadcrumb"),b||C(d,a),!0;else H(d),d.addClass("kmltree-breadcrumb"),b||C(parent,a);else return p(),!1};f.selectById=N;var O=function(d){d=
d.getParentNode();switch(d.getType()){case "KmlNetworkLink":return d;case "GEGlobe":return!1;default:return O(d)}},P=function(d,b){var c=a.element.attr("id");b||(b=[],$("#"+c+" li.KmlNetworkLink").each(function(){$(this).hasClass("loaded")||b.push([this,n(this)])}));c=O(d);if(c===!1)return!1;else{c.getLink().getHref();for(var f=0;f<b.length;f++){var e=b[f][1].getLink().getHref();if(c.getLink().getHref()===e)return b[f][0]}return P(c,b)}},w=function(d,a,b){a||(a=n(d));var d=$(d),c=$(d).is(":visible");
y(d,!0);d.addClass("kmltree-selected");q(d,"selected",!0);c||H(d);b?j(d,a):(kmltreeManager._clearEverythingButMe(f),C(d,a))};f.selectNode=w;var U=function(d,a){d.each(function(b){w(this,null,!!a||!a&&b!==d.length-1)})};f.selectNodes=U;var W=function(d,a){d.each(function(b){V(this,null,!!a||!a&&b!==d.length-1)})};f.deselectNodes=W;var V=function(d,a,b){a||(a=n(d));d=$(d);d.removeClass("kmltree-selected");q(d,"selected",!1);b?i(d,a):ba(d,a)},C=function(d,a){d&&a?j(d,a):r=[];setTimeout(function(){$(f).trigger("select",
[r])},1)},ba=function(d,a){i(d,a);setTimeout(function(){$(f).trigger("select",[r])},1)},H=function(d){d=$(d);d=d.parent().parent();d.addClass("kmltree-breadcrumb");return d.is(":visible")?d:H(d)},p=function(d,b){r=[];var c=$("#"+a.element.attr("id")),f=c.find(".kmltree-selected").removeClass("kmltree-selected");c.find(".kmltree-breadcrumb").removeClass("kmltree-breadcrumb");c.find(".kmltree-cursor-1").removeClass("kmltree-cursor-1");c.find(".kmltree-cursor-2").removeClass("kmltree-cursor-2");f.length&&
f.each(function(){q($(this),"selected",!1)});b||C(null,null);k.getBalloon()&&!d&&k.setBalloon(null)};f.clearSelection=function(){return p()};var R=function(d){D();var d=d||a.loadingMsg,d=$('<div class="kmltree-loading"><span>'+d+"</span></div>"),b=a.element.height();b!==0&&d.height(b);a.element.append(d)};f.showLoading=R;var D=function(){a.element.find(".kmltree-loading").remove()};f.hideLoading=D;var S=function(d,b,t){m={};if(d){v=0;f.kmlObject=d;s.push(d);f.kmlObject.setVisibility(!0);var e=Q(d,
t),g;if(a.displayDocumentRoot===!1)g=e.children[0].children;else if(a.displayDocumentRoot===!0)g=e.children[0];else{g=e.children[0].children;for(var h=0,i=!1;h<g.length&&i===!1;)i=g[h].type==="KmlPlacemark",h++;g=i?e.children[0]:e.children[0].children}g=B(g);a.element.find("div.kmltree").remove();a.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',e.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',g,"</ul></div>"].join(""));
k.getFeatures().appendChild(d);if(!f.previousState&&a.restoreState&&window.localStorage)f.previousState=ca();e=new c({success:function(){D();if(a.setExtent){var b=null,c=$(a.mapElement);c.length&&(b=c.width()/c.height());a.gex.util.flyToObject(d,{boundsFallback:!0,aspectRatio:b});a.setExtent=!1}$(f).trigger("kmlLoaded",[d])},error:function(){D();$(f).trigger("kmlLoadError",[d])},tree:f});f.previousState?X(f.previousState,e):I(e,$("#"+a.element.attr("id")))}else v===0?(v++,setTimeout(function(){jQuery.ajax({url:b,
success:function(){f.load(!0)},error:function(){S(d,b,t)}})},100)):setTimeout(function(){a.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(f).trigger("kmlLoadError",[d])},0)},X=function(d,b){for(var c in d){var f=$("#"+c);if(f.length===1){for(var e in d[c])f.toggleClass(e,d[c][e].value),q(f,e,d[c][e].value),e===
"visible"&&n(f).setVisibility(d[c][e].value);delete d[c]}}$("#"+a.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var a=$(this);!a.hasClass("checkHideChildren")&&!a.hasClass("loading")&&!a.hasClass("loaded")&&!a.hasClass("error")&&b.add(a,function(){X(d,b)})});b.execute()},I=function(d,a){a.find("li.KmlNetworkLink.open").each(function(){var a=$(this);!a.hasClass("checkHideChildren")&&!a.hasClass("loading")&&!a.hasClass("loaded")&&(a.removeClass("open"),d.add(a,function(b){b.addClass("open");
q(b,"open",a.hasClass("open"));I(d,b)}))});d.execute()},B=function(d){if(jQuery.isArray(d)){for(var a=[],b=0;b<d.length;b++)a.push(e(jQuery.extend({},Y,d[b])));return a.join("")}else return e(jQuery.extend({},Y,d))},Y={renderOptions:B},da=function(){$(".KmlNetworkLink").each(function(){var d=n($(this));d&&d.getParentNode()&&a.gex.dom.removeObject(n($(this)))})},T=function(){da();f.kmlObject&&f.kmlObject.getParentNode()&&a.gex.dom.removeObject(f.kmlObject);f.kmlObject=null;s=[]},ca=function(){var d=
localStorage.getItem("kmltree-("+a.url+")");return d?JSON.parse(d):!1};f.destroy=function(){L=!0;kmltreeManager.remove(f);if(a.restoreState&&window.localStorage){var d=JSON.stringify(G());localStorage.setItem("kmltree-("+a.url+")",d)}T();l=null;l={};if(d=k.getBalloon())if(d=d.getFeature())(d=kmltreeManager.getOwner(d))&&d.instance===f&&k.setBalloon(null);k.setBalloon(null);d=a.element.attr("id");$("#"+d+" li > span.name").die();$("#"+d+" li").die();$("#"+d+" li > .expander").die();$(f).die();$(f).unbind();
$("#kmltree-balloon-iframe").remove();a.element.html("")};var n=function(d){d=$(d);return d.length?l[d.attr("id")]:!1};f.lookup=n;var ea=function(d,a){l[d.attr("id")]=a},z=function(d,a){if(a){if(!d.hasClass("checkOffOnly"))if(d.hasClass("radioFolder")){if(!d.find(">ul>li.visible").length){var b=d.find(">ul>li");b.length&&(u($(b[0]),!0),z($(b[0]),!0))}}else d.find(">ul>li").each(function(){var a=$(this);a.hasClass("checkOffOnly")||(u(a,!0),z(a,!0))})}else d.find("li").each(function(){u($(this),!1)})},
J=function(a,b){var c=a.parent().parent();if(!c.hasClass("kmltree"))if(b){var f=c.parent().parent();f.hasClass("radioFolder")&&f.find(">ul>li.visible").each(function(){if(this!==c[0]){var a=$(this);u(a,!1);z(a,!1)}});c.hasClass("visible")||(u(c,!0),J(c,!0))}else c.find(">ul>li.visible").length===0&&(u(c,!1),J(c,!1))},y=function(a,b){if(!a.hasClass("checkOffOnly")||!b){var c=a.parent().parent();c.hasClass("radioFolder")&&c.find(">ul>li.visible").each(function(){u($(this),!1);z($(this),!1)});u(a,b);
(!b||!a.find("li.visible").length)&&z(a,b);J(a,b)}},u=function(a,b){a=$(a);a.hasClass("visible")!==b&&(q(a,"visible",b),n(a).setVisibility(b),a.toggleClass("visible",b))},q=function(a,b,c){a=a.attr("id");m[a]||(m[a]={});a=m[a];a[b]?a[b].value=c:a[b]={original:!c,value:c}},G=function(){for(var a in m){for(var b in m[a])m[a][b].original===m[a][b].value&&delete m[a][b];var c=0;for(b in m[a])m[a].hasOwnProperty(b)&&c++;c===0&&delete m[a]}return m};f.getState=G;f.openNetworkLink=function(b){if(b.find("> ul").length)throw"networklink already loaded";
else{var c=n(b),e=c.getLink();if(e)var g=e=e.getHref();else{var h=kmldom(c.getKml()).find("Url>href");if(h.length)g=e=h.text();else{b.addClass("error");$(b).trigger("loaded",[b,!1]);b.removeClass("open");q(b,"open",!1);return}}h=new URI(e);if(h.getAuthority()===null){window.nl=c;var i=c.getOwnerDocument();if((window.doc=i)&&i.getUrl())if(i=i.getUrl())var i=new URI(i),j=h.resolve(i);j?e=j.toString():alert("Could not resolve relative link in kml ,document. You may need to upgrade to the ,latest Google Earth Plugin.")}a.bustCache&&
(j=(new Date).getTime(),e=e.indexOf("?")===-1?e+"?cachebuster="+j:e+"&cachebuster="+j);b.addClass("loading");google.earth.fetchKml(k,e,function(a){if(a){k.getFeatures().appendChild(a);a.setVisibility(c.getVisibility());var h=c.getName();c.getParentNode().getFeatures().removeChild(c);h=Q(a,g,h);h=B(h.children[0].children);b.append("<ul>"+h+"</ul>");b.addClass("open");q(b,"open",b.hasClass("open"));b.removeClass("loading");b.addClass("loaded");ea(b,a);console.log("opened nl",a.getUrl());s.push(a);window.pushed=
s;console.log("added to docs for",f.kmlObject.getUrl(),jQuery.map(s,function(a){return a.getUrl()}),s.length);fa(b,c);$(b).trigger("loaded",[b,a]);$(f).trigger("networklinkload",[b,a,c])}else alert("Error loading "+e),b.addClass("error"),$(f).trigger("kmlLoadError",[a]),b.removeClass("open")})}};var E=[],fa=function(a,b){$(a).attr("data-rememberedLink",E.length.toString());$(a).data("original-networklink",b);E.push(b)};f.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&E.length>=
a?E[a]:!1};var Z=function(a,b){var e=new c({success:function(c){b&&b(a,c)},error:function(){},tree:f});e.add(a,function(b){b.addClass("open");q(b,"open",a.hasClass("open"));I(e,b)});e.execute()},o=a.element.attr("id");$("#"+o+" li > span.name").live("click",function(b){b.stopPropagation();var c=!1,e=$(this).parent(),g=n(e);e.hasClass("error")&&e.hasClass("KmlNetworkLink")&&(g.getLink()&&g.getLink().getHref()?alert("Could not load NetworkLink with url "+g.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found"));
if(e.hasClass("select"))if(a.multipleSelect&&b.metaKey)e.hasClass("kmltree-selected")?($(".kmltree-cursor-1").removeClass("kmltree-cursor-1"),e.removeClass("kmltree-cursor-1"),V(e,g)):($(".kmltree-cursor-1").removeClass("kmltree-cursor-1"),$(".kmltree-cursor-2").removeClass("kmltree-cursor-2"),e.addClass("kmltree-cursor-1"),w(e,g)),kmltreeManager.pauseListeners(function(){k.setBalloon(null)}),c=!0;else if(a.multipleSelect&&b.shiftKey)if(b=$("#"+a.element.attr("id")),selected=b.find(".kmltree-selected"),
selected.length===1&&selected.addClass("kmltree-cursor-1"),b.find(".kmltree-cursor-1").length===0)p(!0,!0),w(e,g);else{c=e.parent().parent();if(b.find(".kmltree-cursor-1").parent().parent()[0]===c[0]){c=b.find(".kmltree-cursor-2");if(c.length){var h=b.find(".kmltree-cursor-1, .kmltree-cursor-2"),i=h.first(),h=h.last();i.parent().parent().find("> ul > li");i=i.nextUntil('[id="'+h.attr("id")+'"]').andSelf().add(h);c.removeClass("kmltree-cursor-2");W(i,!0)}e.addClass("kmltree-cursor-2");h=b.find(".kmltree-cursor-1, .kmltree-cursor-2");
i=h.first();h=h.last();i[0]===h[0]?b.find(".kmltree-cursor-1, .kmltree-cursor-2").removeClass("kmltree-cursor-2").removeClass("kmltree-cursor-1"):(i.parent().parent().find("> ul > li"),i=i.nextUntil('[id="'+h.attr("id")+'"]').andSelf().add(h));U(i);kmltreeManager.pauseListeners(function(){k.setBalloon(null)})}c=!0}else p(!0,!0),w(e,g);else p(),e.addClass("kmltree-cursor-1"),(e.hasClass("hasDescription")||g.getType()==="KmlPlacemark")&&g.getType()==="KmlPlacemark"&&y(e,!0);c||(g.getType()==="KmlPlacemark"||
g.getDescription())&&kmltreeManager.pauseListeners(function(){kmltreeManager._openBalloon(g,f)});$(f).trigger("click",[e[0],g])});$("#"+o+" li").live("contextmenu",function(a){var b=$(this);b.hasClass("select")&&(b.hasClass("kmltree-selected")||(p(!0,!0),w(b)),setTimeout(function(){$(f).trigger("context",[r])},2));a.preventDefault();return!1});a.element.click(function(a){var b=$(a.target);a.target===this||b.hasClass("toggle")&&b.hasClass("select");(b.find(".kmltree-selected").length||b.find(".kmltree-breadcrumb").length)&&
p()});$("#"+o+" li > .expander").live("click",function(){var a=$(this).parent(),b=a.hasClass("open");a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading")?Z(a,function(c){c.hasClass("kmltree-breadcrumb")&&(b?a.find(".kmltree-selected").length&&a.addClass("kmltree-breadcrumb"):a.removeClass("kmltree-breadcrumb"),c=k.getBalloon().getFeature(),N(c.getId(),c,!0))}):(a.toggleClass("open"),q(a,"open",a.hasClass("open")),b?a.find(".kmltree-selected").length&&a.addClass("kmltree-breadcrumb"):
a.removeClass("kmltree-breadcrumb"))});$("#"+o+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");!b&&a.hasClass("kmltree-selected")&&p();!b&&k.getBalloon()&&k.setBalloon(null);if(!a.hasClass("checkOffOnly")||!b)a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")?(Z(a),$(a).bind("loaded",function(a,b){y(b,!0);b.removeClass("open")})):y(a,b),$(f).trigger("toggleItem",[a,b,n(a)])});$("#"+
o+" li").live("dblclick",function(b){b.stopPropagation();var c=$(b.target),b=c.parent();if(!c.hasClass("expander")&&!c.hasClass("toggler")&&!b.hasClass("expander")&&!b.hasClass("toggler")){var c=$(this),e=n(c);if(c.hasClass("error"))e.getLink()&&e.getLink().getHref()?alert("Could not load NetworkLink with url "+e.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{y(c,!0);if(e.getType()=="KmlTour")k.getTourPlayer().setTour(e);else{var g=null,h=$(a.mapElement);
h.length&&(g=h.width()/h.height());a.gex.util.flyToObject(e,{boundsFallback:b.find("li").length<1E3,aspectRatio:g})}$(f).trigger("dblclick",[c,e])}}});var K=!1;google.earth.addEventListener(k.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe"&&b.getType()==="KmlPlacemark"){var a=b.getId(),c=F(a);c.length>=1&&!K&&(K=!0,setTimeout(function(){K=!1;var a=$(c[0]);$(f).trigger("dblclick",[a,b])},200))}}});f.removeEventListener=f.detachEvent=function(){};
kmltreeManager.register(f,{opts:a,docs:s});f.docs=s;return f}}(),enableGoogleLayersControl=function(){var g=function(c,e,b){if((c=c.getId())&&c.match(/^LAYER/))b.getLayerRoot().enableLayerById(b[c],e);else{var a=b.getOptions();switch(c){case "SUN":b.getSun().setVisibility(e);break;case "NAVIGATION_CONTROLS":c=b.VISIBILITY_SHOW;if(!e)c=b.VISIBILITY_HIDE;b.getNavigationControl().setVisibility(c);break;case "STATUS_BAR":a.setStatusBarVisibility(e);break;case "OVERVIEW_MAP":a.setOverviewMapVisibility(e);
break;case "SCALE_LEGEND":a.setScaleLegendVisibility(e);break;case "ATMOSPHERE":a.setAtmosphereVisibility(e);break;case "HISTORICAL_IMAGERY":b.getTime().setHistoricalImageryEnabled(e);break;case "GRID":a.setGridVisibility(e);break;case "STREET_VIEW":b.getNavigationControl().setStreetViewEnabled(e)}}};return function(c,e){(!c||!e)&&alert("Must call enableGoogleLayersControl with both tree and ge options!");$(c).bind("toggleItem",function(b,a,c,j){g(j,c,e)});$(c).bind("kmlLoaded",function(b,a){for(var c=
a.getFeatures().getChildNodes(),j=c.getLength(),i=0;i<j;i++){var f=c.item(i);g(f,f.getVisibility(),e)}})}}();
