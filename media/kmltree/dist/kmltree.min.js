var kmltreeManager=function(){function p(l){i=l;google.earth.addEventListener(i,"balloonopening",k);google.earth.addEventListener(i,"balloonclose",o);google.earth.addEventListener(i.getGlobe(),"click",function(j){if(j.getButton()!==-1)if(j.getTarget().getType()==="GEGlobe"&&$(".kmltree-selected").length)for(j=0;j<f.length;j++){var m=$(f[j].api.opts.element);m.find(".kmltree-selected").length+m.find(".kmltree-breadcrumb").length>0&&f[j].instance.clearSelection()}})}that={};var f=[],i,e={};that.register=
function(l,j){f.length===0&&p(j.opts.gex.pluginInstance);f.push({key:"kmltree-tree-"+f.length.toString(),instance:l,api:j})};that.remove=function(l){for(var j=0;j<f.length;j++)if(f[j].instance===l){f.splice(j,1);break}for(var m in e)e[m].instance===l&&delete e[m];return l};that.pauseListeners=function(l){google.earth.removeEventListener(i,"balloonopening",k);google.earth.removeEventListener(i,"balloonclose",o);l();google.earth.addEventListener(i,"balloonopening",k);google.earth.addEventListener(i,
"balloonclose",o)};var c=function(l){for(var j=0;j<f.length;j++)if(f[j].instance===l)return f[j].api},k=function(l){var j=l.getFeature(),m=g(j);if(m){l.preventDefault();i.setBalloon(null);l=false;var C=j.getId();if(C){l=m.api.opts.selectable;if(typeof l==="function")l=l(j)}l&&m.instance.selectById(C,j);v(j,m);return false}},o=function(){$("#kmltree-balloon-iframe").remove();for(var l=0;l<f.length;l++){var j=$(f[l].api.opts.element);j.find(".kmltree-selected").length+j.find(".KmlNetworkLink.kmltree-breadcrumb:not(.loaded)").length===
1&&j.find(".kmltree-cursor-2").length===0&&f[l].instance.clearSelection()}};that._clearEverythingButMe=function(l){for(var j=0;j<f.length;j++)if(f[j].instance!==l)if($(f[j].api.opts.element).find(".kmltree-selected").length||$(f[j].api.opts.element).find(".kmltree-breadcrumb").length)f[j].instance.clearSelection()};var r=function(l,j){if(!l)return false;if(l.getUrl()===j)return true;if(l.getElementByUrl(j))return true},g=function(l){l=l.getUrl();var j=l.split("#")[0];j=j.replace(/cachebuster=\d+/,
"");if(j.indexOf("?")===j.length-1)j=j.replace("?","");if(e[j])return e[j];for(var m=0;m<f.length;m++)if(r(f[m].instance.kmlObject,l)){e[j]=f[m];return f[m]}for(m=0;m<f.length;m++)for(var C=f[m].api.docs,u=0;u<C.length;u++)if(r(C[u],l)){e[j]=f[m];return f[m]}return false};that.getOwner=function(l){return(l=g(l))?l.instance:false};var v=function(l,j){$(window).unbind("message.kmlTreeIframeEvents");var m;j=j.instance?j.instance:j;var C=j.api?j.api:c(j);m=C.opts.displayEnhancedContent;if(typeof m===
"function")m=m(l);if(m){var u=l.getBalloonHtmlUnsafe(),w=l.getBalloonHtml();w=$.trim(w.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,""));w=w!=$.trim(u)}if(m&&w){m=i.createHtmlDivBalloon("");var x=document.createElement("iframe");x.setAttribute("src",C.opts.iframeSandbox);x.setAttribute("frameBorder","0");x.setAttribute("id","kmltree-balloon-iframe");w=document.createElement("div");$(w).append(x);$(x).one("load",function(){$(window).bind("message.kmlTreeIframeEvents",{window:x.contentWindow},
function(y){var t=y.originalEvent;if(t.source===y.data.window){y=i.getBalloon();var H=y.getFeature();if(!(!$("#kmltree-balloon-iframe").length||!(t.data.match(/width/)||t.data.match(/unknownIframeDimensions/))||y.getType()!=="GEHtmlDivBalloon")){var K=g(H);t=JSON.parse(t.data);if(t.unknownIframeDimensions){t=K.api.opts.unknownIframeDimensionsDefault;if(typeof t==="function")t=t(H)}var L=$("#kmltree-balloon-iframe");y.setMinWidth(t.width);y.setMaxWidth(t.width+t.width*0.1);y.setMinHeight(t.height);
y.setMaxHeight(t.height+t.height*0.1);L.height(t.height);L.width(t.width);$(K.instance).trigger("balloonopen",[y,H])}}});this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(u),callback:Base64.encode(C.opts.sandboxedBalloonCallback.toString())}),"*")});m.setContentDiv(w)}else{m=i.createFeatureBalloon("");var P=function(y){google.earth.removeEventListener(i,"balloonopening",P);setTimeout(function(){$(j).trigger("balloonopen",[y.getBalloon(),y.getFeature()])},1)};google.earth.addEventListener(i,
"balloonopening",P)}m.setFeature(l);i.setBalloon(m)};that._openBalloon=v;return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(p){var f="",i,e,c,k,o,r,g=0;for(p=Base64._utf8_encode(p);g<p.length;){i=p.charCodeAt(g++);e=p.charCodeAt(g++);c=p.charCodeAt(g++);k=i>>2;i=(i&3)<<4|e>>4;o=(e&15)<<2|c>>6;r=c&63;if(isNaN(e))o=r=64;else if(isNaN(c))r=64;f=f+this._keyStr.charAt(k)+this._keyStr.charAt(i)+this._keyStr.charAt(o)+this._keyStr.charAt(r)}return f},
decode:function(p){var f="",i,e,c,k,o,r=0;for(p=p.replace(/[^A-Za-z0-9\+\/\=]/g,"");r<p.length;){i=this._keyStr.indexOf(p.charAt(r++));e=this._keyStr.indexOf(p.charAt(r++));k=this._keyStr.indexOf(p.charAt(r++));o=this._keyStr.indexOf(p.charAt(r++));i=i<<2|e>>4;e=(e&15)<<4|k>>2;c=(k&3)<<6|o;f+=String.fromCharCode(i);if(k!=64)f+=String.fromCharCode(e);if(o!=64)f+=String.fromCharCode(c)}return f=Base64._utf8_decode(f)},_utf8_encode:function(p){p=p.replace(/\r\n/g,"\n");for(var f="",i=0;i<p.length;i++){var e=
p.charCodeAt(i);if(e<128)f+=String.fromCharCode(e);else{if(e>127&&e<2048)f+=String.fromCharCode(e>>6|192);else{f+=String.fromCharCode(e>>12|224);f+=String.fromCharCode(e>>6&63|128)}f+=String.fromCharCode(e&63|128)}}return f},_utf8_decode:function(p){for(var f="",i=0,e=c1=c2=0;i<p.length;){e=p.charCodeAt(i);if(e<128){f+=String.fromCharCode(e);i++}else if(e>191&&e<224){c2=p.charCodeAt(i+1);f+=String.fromCharCode((e&31)<<6|c2&63);i+=2}else{c2=p.charCodeAt(i+1);c3=p.charCodeAt(i+2);f+=String.fromCharCode((e&
15)<<12|(c2&63)<<6|c3&63);i+=3}}return f}};(function(){var p={};this.tmpl=function f(i,e){var c=!/\W/.test(i)?p[i]=p[i]||f(document.getElementById(i).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+i.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return e?c(e):c}})();
kmldom=function(){return function(p){if(window.ActiveXObject&&window.GetObject){var f=new ActiveXObject("Microsoft.XMLDOM");f.loadXML(p);return jQuery(f)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(p,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function p(e,c){var k=/^(.*)\//;return e.authority&&!e.path?"/"+c:e.getPath().match(k)[0]+c}function f(e){if(!e)return"";e=e.replace(/\/\.\//g,"/");for(e=e.replace(/\/\.$/,"/");e.match(i);)e=e.replace(i,"/");for(e=e.replace(/\/([^\/]*)\/\.\.$/,"/");e.match(/\/\.\.\//);)e=e.replace(/\/\.\.\//,"/");return e}var i=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(e){e||(e="");e=e.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);var c=e[1]||null,k=e[2]||null,o=
e[3]||null,r=e[4]||null,g=e[5]||null;this.getScheme=function(){return c};this.setScheme=function(v){c=v};this.getAuthority=function(){return k};this.setAuthority=function(v){k=v};this.getPath=function(){return o};this.setPath=function(v){o=v};this.getQuery=function(){return r};this.setQuery=function(v){r=v};this.getFragment=function(){return g};this.setFragment=function(v){g=v}};URI.prototype.toString=function(){var e="";if(this.getScheme())e+=this.getScheme()+":";if(this.getAuthority())e+="//"+this.getAuthority();
if(this.getPath())e+=this.getPath();if(this.getQuery())e+="?"+this.getQuery();if(this.getFragment())e+="#"+this.getFragment();return e};URI.prototype.resolve=function(e){var c=new URI;if(this.getScheme()){c.setScheme(this.getScheme());c.setAuthority(this.getAuthority());c.setPath(f(this.getPath()));c.setQuery(this.getQuery())}else{if(this.getAuthority()){c.setAuthority(this.getAuthority());c.setPath(f(this.getPath()));c.setQuery(this.getQuery())}else{if(this.getPath()){if(this.getPath().charAt(0)===
"/")c.setPath(f(this.getPath()));else{c.setPath(p(e,this.getPath()));c.setPath(f(c.getPath()))}c.setQuery(this.getQuery())}else{c.setPath(e.getPath());this.getQuery()?c.setQuery(this.getQuery()):c.setQuery(e.getQuery())}c.setAuthority(e.getAuthority())}c.setScheme(e.getScheme())}c.setFragment(this.getFragment());return c};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(e,
c){var k=new URIQuery;if(c)k.separator=c;k.addStringParams(e);return k};URIQuery.prototype.addStringParams=function(e){e=e.split(this.separator);for(var c,k,o=0;o<e.length;o++){c=e[o].split("=",2);k=c[0].replace(/\+/g," ");c=c[1].replace(/\+/g," ");this.params.hasOwnProperty(k)||(this.params[k]=[]);this.params[k].push(c)}};URIQuery.prototype.getParam=function(e){if(this.params.hasOwnProperty(e))return this.params[e][0];return null};URIQuery.prototype.toString=function(){var e=[],c;c=this.params;var k=
[],o;for(o in c)c.hasOwnProperty(o)&&k.push(o);c=k.sort();for(k=0;k<c.length;k++)for(o=0;o<this.params[c[k]].length;o++)e.push(c[k].replace(/ /g,"+")+"="+this.params[c[k]][o].replace(/ /g,"+"));return e.join(this.separator)}})();
var kmltree=function(){function p(c){var k=document.createElement("a");k.href=c;return k.href}var f=function(c){if(c.success&&c.error&&c.tree){this.queue=[];this.opts=c}else throw"missing required option";};f.prototype.add=function(c,k){this.queue.push({node:c,callback:k,loaded:false,errors:false})};f.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var c=0;c<this.queue.length;c++){var k=this.queue[c];k.node.data("queueItem",k);if(!k.loaded&&!k.loading){var o=this;
$(k.node).bind("loaded",function(r,g,v){o.nodeLoadedCallback(r,g,v)});this.opts.tree.openNetworkLink(k.node);k.loading=true}}};f.prototype.nodeLoadedCallback=function(c,k){var o=k.data("queueItem");if(o.loaded===true)throw"event listener fired twice for "+k.find(">span.name").text();o.loaded=true;o.loading=false;$(k).unbind("loaded");o.callback(k);this.execute();this.finish(o)};f.prototype.finish=function(){for(var c=true,k=true,o=0;o<this.queue.length;o++){c=c&&this.queue[o].loaded;k=k&&!this.queue[o].errors}if(c){k?
this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};f.prototype.destroy=function(){for(var c=0;c<this.queue.length;c++)this.queue[c].node.unbind("load");this.queue=[]};var i=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= classname %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
e={refreshWithState:true,bustCache:false,restoreState:false,whitelist:[],supportItemIcon:false,loadingMsg:"Loading data",setExtent:false,displayDocumentRoot:"auto",displayEnhancedContent:false,iframeSandbox:"http://kmltree.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){},selectable:function(){return false},multipleSelect:false,classname:function(){return""}};return function(c){function k(a){for(var b=0;b<w.length;b++)if($(w[b].node)[0]===
$(a)[0])return b;return-1}function o(a,b){k(a,b)===-1&&w.push({node:a,kmlObject:b})}function r(a,b){var d=k(a,b);if(d===-1)throw"removeSelectData error";else w.splice(d,1)}var g={},v=0,l={};g.lookupTable=l;g.kmlObject=null;var j=[];c=jQuery.extend({},e,c);var m=c.gex.pluginInstance,C=false,u={},w=[];g.url=c.url;parseFloat(m.getApiVersion())<1.005&&alert("kmltree requires a google earth plugin version >= 1.005");if(!c.url||!c.gex||!c.element||!c.mapElement)throw"kmltree requires options url, gex, mapElement & element";
c.element=$(c.element);if(!c.element.attr("id")){c.element.attr("id","kml-tree"+(new Date).getTime());c.element.attr("UNSELECTABLE","on")}c.restoreState&&$(window).unload(function(){g.destroy()});c.element.css("position")!=="absolute"&&$(c.element).css({position:"relative"});var x=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),P=x[0].style.backgroundSize!==
undefined||x[0].style.MozBackgroundSize!==undefined||x[0].style.oBackgroundSize!==undefined||x[0].style.khtmlBackgroundSize!==undefined||x[0].style.webkitBackgroundSize!==undefined,y=function(a,b,d){var h={name:a.getName(),id:"kml"+(d?d.replace(/\W/g,"-"):"")+b.replace(/\W/g,"-")};google.earth.executeBatch(m,function(){c.gex.dom.walk({visitCallback:function(n){var q=n.current;if(!q.children)q.children=[];var z=this.getName(),s;s=q.id;key=z?z.replace(/\W/g,"-"):"blank";s+=key;for(var A=0;l[s];){A++;
s+=A}l[s]=this;var Q=this.getSnippet();if(!Q||Q==="empty")Q=false;A=this.getType();var ba=false;if(A==="KmlPlacemark"){var R=this.getGeometry();if(R)ba=R.getType()}var M=this.getComputedStyle(),J=c.selectable;if(typeof J==="function")J=J(this);J=J&&this.getId();z=z||"&nbsp;";R=!!this.getVisibility();var ma=this.getOpen(),na=this.getDescription(),D="check";if(M=M.getListStyle())switch(M.getListItemType()){case 5:D="radioFolder";break;case 2:D="checkOffOnly";break;case 3:D="checkHideChildren"}M=D;D=
false;if(P&&this.getType()==="KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")D=this.getComputedStyle().getIconStyle().getIcon().getHref();if(c.supportItemIcon)D=(D=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?D:false;s={renderOptions:S,name:z,visible:R,type:A,open:ma,id:s,description:na,snippet:Q,select:J,listItemType:M,customIcon:D,classname:c.classname(this),children:[],alwaysRenderNodes:false,
kmlId:this.getId().replace(/\W/g,"-"),geoType:ba};q.children.push(s);if(s.listItemType!=="checkHideChildren")n.child=s;else n.walkChildren=false},rootObject:a,rootContext:h})});return h},t=function(a){if(g.kmlObject)throw"KML already loaded";ca();var b=p(c.url);if(a||c.bustCache){a=(new Date).getTime();b=b.indexOf("?")===-1?b+"?cachebuster="+a:b+"&cachebuster="+a}google.earth.fetchKml(m,b,function(d){C||da(d,b,c.url)})};g.load=t;g.refresh=function(){if(c.refreshWithState)g.previousState=W();ea();
l=null;l={};m.setBalloon(null);t(true)};var H=function(a){return c.element.find("."+a.replace(/\W/g,"-"))};g.getNodesById=H;g.expandParentsOf=function(a){a=$(a);for(a=a.parent().parent();!a.hasClass("kmltree")&&!a.find(">ul:visible").length;){a.addClass("open");a=a.parent().parent()}};var K=function(a,b,d){a=H(a);if(a.length){a=$(a[0]);E(true,true);I(a,b||B(a),d);return true}else if(a=fa(b)){a=$(a);if(a.is(":visible")){E(true,true);a.addClass("kmltree-breadcrumb");d||T(a,b);return true}else{X(a);
a.addClass("kmltree-breadcrumb");d||T(parent,b)}}else{E();return false}};g.selectById=K;var L=function(a){a=a.getParentNode();switch(a.getType()){case "KmlNetworkLink":return a;case "GEGlobe":return false;default:return L(a)}},fa=function(a,b){var d=c.element.attr("id");if(!b){b=[];$("#"+d+" li.KmlNetworkLink").each(function(){$(this).hasClass("loaded")||b.push([this,B(this)])})}d=L(a);if(d===false)return false;else{d.getLink().getHref();for(var h=0;h<b.length;h++){var n=b[h][1].getLink().getHref();
if(d.getLink().getHref()===n)return b[h][0]}return fa(d,b)}},I=function(a,b,d){b||(b=B(a));a=$(a);var h=$(a).is(":visible");N(a,true);a.addClass("kmltree-selected");F(a,"selected",true);h||X(a);if(d)o(a,b);else{kmltreeManager._clearEverythingButMe(g);T(a,b)}};g.selectNode=I;var ga=function(a,b){a.each(function(d){I(this,null,!!b||!b&&d!==a.length-1)})};g.selectNodes=ga;var ia=function(a,b){a.each(function(d){ha(this,null,!!b||!b&&d!==a.length-1)})};g.deselectNodes=ia;var ha=function(a,b,d){b||(b=
B(a));a=$(a);a.removeClass("kmltree-selected");F(a,"selected",false);d?r(a,b):oa(a,b)},T=function(a,b){if(a&&b)o(a,b);else w=[];setTimeout(function(){$(g).trigger("select",[w])},1)},oa=function(a,b){r(a,b);setTimeout(function(){$(g).trigger("select",[w])},1)},X=function(a){a=$(a);a=a.parent().parent();a.addClass("kmltree-breadcrumb");return a.is(":visible")?a:X(a)},E=function(a,b){w=[];var d=$("#"+c.element.attr("id")),h=d.find(".kmltree-selected").removeClass("kmltree-selected");d.find(".kmltree-breadcrumb").removeClass("kmltree-breadcrumb");
d.find(".kmltree-cursor-1").removeClass("kmltree-cursor-1");d.find(".kmltree-cursor-2").removeClass("kmltree-cursor-2");h.length&&h.each(function(){F($(this),"selected",false)});b||T(null,null);m.getBalloon()&&!a&&m.setBalloon(null)};g.clearSelection=function(){return E()};var ca=function(a){U();a=a||c.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var b=c.element.height();b!==0&&a.height(b);c.element.append(a)};g.showLoading=ca;var U=function(){c.element.find(".kmltree-loading").remove()};
g.hideLoading=U;var da=function(a,b,d){u={};if(a){v=0;g.kmlObject=a;j.push(a);g.kmlObject.setVisibility(true);var h=y(a,d),n;if(c.displayDocumentRoot===false)n=h.children[0].children;else if(c.displayDocumentRoot===true)n=h.children[0];else{n=h.children[0].children;for(var q=0,z=false;q<n.length&&z===false;){z=n[q].type==="KmlPlacemark";q++}n=z?h.children[0]:h.children[0].children}n=S(n);c.element.find("div.kmltree").remove();c.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',
h.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',n,"</ul></div>"].join(""));m.getFeatures().appendChild(a);if(!g.previousState)if(c.restoreState&&window.localStorage)g.previousState=pa();h=new f({success:function(){U();if(c.setExtent){var s=null,A=$(c.mapElement);if(A.length)s=A.width()/A.height();c.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:s});c.setExtent=false}$(g).trigger("kmlLoaded",[a])},error:function(){U();$(g).trigger("kmlLoadError",[a])},tree:g});g.previousState?
ja(g.previousState,h):Y(h,$("#"+c.element.attr("id")))}else if(v===0){v++;setTimeout(function(){jQuery.ajax({url:b,success:function(){g.load(true)},error:function(){da(a,b,d)}})},100)}else setTimeout(function(){c.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(g).trigger("kmlLoadError",[a])},0)},ja=function(a,
b){for(var d in a){var h=$("#"+d);if(h.length===1){for(var n in a[d]){h.toggleClass(n,a[d][n].value);F(h,n,a[d][n].value);n==="visible"&&B(h).setVisibility(a[d][n].value)}delete a[d]}}$("#"+c.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var q=$(this);!q.hasClass("checkHideChildren")&&!q.hasClass("loading")&&!q.hasClass("loaded")&&!q.hasClass("error")&&b.add(q,function(){ja(a,b)})});b.execute()},Y=function(a,b){b.find("li.KmlNetworkLink.open").each(function(){var d=$(this);if(!d.hasClass("checkHideChildren")&&
!d.hasClass("loading")&&!d.hasClass("loaded")){d.removeClass("open");a.add(d,function(h){h.addClass("open");F(h,"open",d.hasClass("open"));Y(a,h)})}});a.execute()},S=function(a){if(jQuery.isArray(a)){for(var b=[],d=0;d<a.length;d++)b.push(i(jQuery.extend({},ka,a[d])));return b.join("")}else return i(jQuery.extend({},ka,a))},ka={renderOptions:S},qa=function(){$(".KmlNetworkLink").each(function(){var a=B($(this));a&&a.getParentNode()&&c.gex.dom.removeObject(B($(this)))})},ea=function(){qa();g.kmlObject&&
g.kmlObject.getParentNode()&&c.gex.dom.removeObject(g.kmlObject);g.kmlObject=null;j=[]},pa=function(){var a=localStorage.getItem("kmltree-("+c.url+")");return a?JSON.parse(a):false};g.destroy=function(){C=true;kmltreeManager.remove(g);if(c.restoreState&&window.localStorage){var a=JSON.stringify(W());localStorage.setItem("kmltree-("+c.url+")",a)}ea();l=null;l={};if(a=m.getBalloon())if(a=a.getFeature())(a=kmltreeManager.getOwner(a))&&a.instance===g&&m.setBalloon(null);m.setBalloon(null);a=c.element.attr("id");
$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();$(g).die();$(g).unbind();$("#kmltree-balloon-iframe").remove();c.element.html("")};var B=function(a){a=$(a);return a.length?l[a.attr("id")]:false};g.lookup=B;var O=function(a,b){if(b){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var d=a.find(">ul>li");if(d.length){G($(d[0]),true);O($(d[0]),true)}}}else a.find(">ul>li").each(function(){var h=$(this);if(!h.hasClass("checkOffOnly")){G(h,
true);O(h,true)}})}else a.find("li").each(function(){G($(this),false)})},Z=function(a,b){var d=a.parent().parent();if(!d.hasClass("kmltree"))if(b){var h=d.parent().parent();h.hasClass("radioFolder")&&h.find(">ul>li.visible").each(function(){if(this!==d[0]){var n=$(this);G(n,false);O(n,false)}});if(!d.hasClass("visible")){G(d,true);Z(d,true)}}else if(d.find(">ul>li.visible").length===0){G(d,false);Z(d,false)}},N=function(a,b){if(!(a.hasClass("checkOffOnly")&&b)){var d=a.parent().parent();d.hasClass("radioFolder")&&
d.find(">ul>li.visible").each(function(){G($(this),false);O($(this),false)});G(a,b);b&&a.find("li.visible").length||O(a,b);Z(a,b)}},G=function(a,b){a=$(a);if(a.hasClass("visible")!==b){F(a,"visible",b);B(a).setVisibility(b);a.toggleClass("visible",b)}},F=function(a,b,d){a=a.attr("id");u[a]||(u[a]={});a=u[a];if(a[b])a[b].value=d;else a[b]={original:!d,value:d}},W=function(){for(var a in u){for(var b in u[a])u[a][b].original===u[a][b].value&&delete u[a][b];var d=0;for(b in u[a])u[a].hasOwnProperty(b)&&
d++;d===0&&delete u[a]}return u};g.getState=W;g.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var b=B(a),d=b.getLink();if(d)var h=d=d.getHref();else{var n=kmldom(b.getKml()).find("Url>href");if(n.length)h=d=n.text();else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");F(a,"open",false);return}}n=new URI(d);if(n.getAuthority()===null){window.nl=b;var q=b.getOwnerDocument();if((window.doc=q)&&q.getUrl())if(q=q.getUrl()){q=new URI(q);
var z=n.resolve(q)}if(z)d=z.toString();else alert(["Could not resolve relative link in kml ","document. You may need to upgrade to the ","latest Google Earth Plugin."].join())}if(c.bustCache){z=(new Date).getTime();d=d.indexOf("?")===-1?d+"?cachebuster="+z:d+"&cachebuster="+z}a.addClass("loading");google.earth.fetchKml(m,d,function(s){if(s){m.getFeatures().appendChild(s);s.setVisibility(b.getVisibility());var A=b.getName();b.getParentNode().getFeatures().removeChild(b);A=y(s,h,A);A=S(A.children[0].children);
a.append("<ul>"+A+"</ul>");a.addClass("open");F(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");l[a.attr("id")]=s;j.push(s);$(a).attr("data-rememberedLink",V.length.toString());V.push(b);$(a).trigger("loaded",[a,s]);$(g).trigger("networklinkload",[a,s])}else{alert("Error loading "+d);a.addClass("error");$(g).trigger("kmlLoadError",[s]);a.removeClass("open")}})}};var V=[];g.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&V.length>=a?V[a]:false};var la=
function(a,b){var d=new f({success:function(h){b&&b(a,h)},error:function(){},tree:g});d.add(a,function(h){h.addClass("open");F(h,"open",a.hasClass("open"));Y(d,h)});d.execute()};x=c.element.attr("id");$("#"+x+" li > span.name").live("click",function(a){a.stopPropagation();var b=false,d=$(this).parent(),h=B(d);if(d.hasClass("error")&&d.hasClass("KmlNetworkLink"))h.getLink()&&h.getLink().getHref()?alert("Could not load NetworkLink with url "+h.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");
if(d.hasClass("select"))if(c.multipleSelect&&a.metaKey){if(d.hasClass("kmltree-selected")){$(".kmltree-cursor-1").removeClass("kmltree-cursor-1");d.removeClass("kmltree-cursor-1");ha(d,h)}else{$(".kmltree-cursor-1").removeClass("kmltree-cursor-1");$(".kmltree-cursor-2").removeClass("kmltree-cursor-2");d.addClass("kmltree-cursor-1");I(d,h)}kmltreeManager.pauseListeners(function(){m.setBalloon(null)});b=true}else if(c.multipleSelect&&a.shiftKey){a=$("#"+c.element.attr("id"));selected=a.find(".kmltree-selected");
selected.length===1&&selected.addClass("kmltree-cursor-1");if(a.find(".kmltree-cursor-1").length===0){E(true,true);I(d,h)}else{b=d.parent().parent();if(a.find(".kmltree-cursor-1").parent().parent()[0]===b[0]){b=a.find(".kmltree-cursor-2");if(b.length){var n=a.find(".kmltree-cursor-1, .kmltree-cursor-2"),q=n.first();n=n.last();q.parent().parent().find("> ul > li");q=q.nextUntil('[id="'+n.attr("id")+'"]').andSelf().add(n);b.removeClass("kmltree-cursor-2");ia(q,true)}d.addClass("kmltree-cursor-2");n=
a.find(".kmltree-cursor-1, .kmltree-cursor-2");q=n.first();n=n.last();if(q[0]===n[0])a.find(".kmltree-cursor-1, .kmltree-cursor-2").removeClass("kmltree-cursor-2").removeClass("kmltree-cursor-1");else{q.parent().parent().find("> ul > li");q=q.nextUntil('[id="'+n.attr("id")+'"]').andSelf().add(n)}ga(q);kmltreeManager.pauseListeners(function(){m.setBalloon(null)})}b=true}}else{E(true,true);I(d,h)}else{E();d.addClass("kmltree-cursor-1");if(d.hasClass("hasDescription")||h.getType()==="KmlPlacemark")h.getType()===
"KmlPlacemark"&&N(d,true)}b||kmltreeManager.pauseListeners(function(){kmltreeManager._openBalloon(h,g)});$(g).trigger("click",[d[0],h])});$("#"+x+" li").live("contextmenu",function(a){var b=$(this);if(b.hasClass("select")){if(!b.hasClass("kmltree-selected")){E(true,true);I(b)}setTimeout(function(){$(g).trigger("context",[w])},2)}a.preventDefault();return false});c.element.click(function(a){var b=$(a.target);a.target!==this&&b.hasClass("toggle")&&b.hasClass("select");if(b.find(".kmltree-selected").length||
b.find(".kmltree-breadcrumb").length)E()});$("#"+x+" li > .expander").live("click",function(){var a=$(this).parent(),b=a.hasClass("open");if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))la(a,function(d){if(d.hasClass("kmltree-breadcrumb")){if(b)a.find(".kmltree-selected").length&&a.addClass("kmltree-breadcrumb");else a.removeClass("kmltree-breadcrumb");d=m.getBalloon().getFeature();K(d.getId(),d,true)}});else{a.toggleClass("open");F(a,"open",a.hasClass("open"));if(b)a.find(".kmltree-selected").length&&
a.addClass("kmltree-breadcrumb");else a.removeClass("kmltree-breadcrumb")}});$("#"+x+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");!b&&a.hasClass("kmltree-selected")&&E();!b&&m.getBalloon()&&m.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&b)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){la(a);$(a).bind("loaded",function(d,h){N(h,true);h.removeClass("open")})}else N(a,
b);$(g).trigger("toggleItem",[a,b,B(a)])}});$("#"+x+" li").live("dblclick",function(a){a.stopPropagation();var b=$(a.target);a=b.parent();if(!(b.hasClass("expander")||b.hasClass("toggler")||a.hasClass("expander")||a.hasClass("toggler"))){b=$(this);var d=B(b);if(b.hasClass("error"))d.getLink()&&d.getLink().getHref()?alert("Could not load NetworkLink with url "+d.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{N(b,true);if(d.getType()=="KmlTour")m.getTourPlayer().setTour(d);
else{var h=null,n=$(c.mapElement);if(n.length)h=n.width()/n.height();c.gex.util.flyToObject(d,{boundsFallback:a.find("li").length<1E3,aspectRatio:h})}$(g).trigger("dblclick",[b,d])}}});var aa=false;google.earth.addEventListener(m.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe")if(b.getType()==="KmlPlacemark"){a=b.getId();var d=H(a);if(d.length>=1)if(!aa){aa=true;setTimeout(function(){aa=false;var h=$(d[0]);$(g).trigger("dblclick",[h,b])},200)}}}});
g.removeEventListener=g.detachEvent=function(){};kmltreeManager.register(g,{opts:c,docs:j});return g}}(),enableGoogleLayersControl=function(){var p=function(f,i,e){if((f=f.getId())&&f.match(/^LAYER/))e.getLayerRoot().enableLayerById(e[f],i);else{var c=e.getOptions();switch(f){case "SUN":e.getSun().setVisibility(i);break;case "NAVIGATION_CONTROLS":f=e.VISIBILITY_SHOW;if(!i)f=e.VISIBILITY_HIDE;e.getNavigationControl().setVisibility(f);break;case "STATUS_BAR":c.setStatusBarVisibility(i);break;case "OVERVIEW_MAP":c.setOverviewMapVisibility(i);
break;case "SCALE_LEGEND":c.setScaleLegendVisibility(i);break;case "ATMOSPHERE":c.setAtmosphereVisibility(i);break;case "HISTORICAL_IMAGERY":e.getTime().setHistoricalImageryEnabled(i);break;case "GRID":c.setGridVisibility(i);break;case "STREET_VIEW":e.getNavigationControl().setStreetViewEnabled(i)}}};return function(f,i){if(!f||!i)alert("Must call enableGoogleLayersControl with both tree and ge options!");$(f).bind("toggleItem",function(e,c,k,o){p(o,k,i)});$(f).bind("kmlLoaded",function(e,c){for(var k=
c.getFeatures().getChildNodes(),o=k.getLength(),r=0;r<o;r++){var g=k.item(r);p(g,g.getVisibility(),i)}})}}();
