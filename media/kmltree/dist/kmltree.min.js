var kmltreeManager=function(){function h(a){e=a;google.earth.addEventListener(e,"balloonopening",g);google.earth.addEventListener(e,"balloonclose",i);google.earth.addEventListener(e.getGlobe(),"click",function(a){if(a.getButton()!==-1&&a.getTarget().getType()==="GEGlobe"&&$(".kmltree-selected").length)for(a=0;a<c.length;a++){var b=$(c[a].api.opts.element);b.find(".kmltree-selected").length+b.find(".kmltree-breadcrumb").length>0&&c[a].instance.clearSelection()}})}that={};var c=[],e,b={};that.register=
function(a,b){c.length===0&&h(b.opts.gex.pluginInstance);c.push({key:"kmltree-tree-"+c.length.toString(),instance:a,api:b})};that.remove=function(a){for(var f=0;f<c.length;f++)if(c[f].instance===a){c.splice(f,1);break}for(var g in b)b[g].instance===a&&delete b[g];return a};that.pauseListeners=function(a){google.earth.removeEventListener(e,"balloonopening",g);google.earth.removeEventListener(e,"balloonclose",i);a();google.earth.addEventListener(e,"balloonopening",g);google.earth.addEventListener(e,
"balloonclose",i)};var a=function(a){for(var b=0;b<c.length;b++)if(c[b].instance===a)return c[b].api},g=function(a){var b=a.getFeature(),c=f(b);if(c){a.preventDefault();e.setBalloon(null);var a=!1,g=b.getId();if(g)a=c.api.opts.selectable,typeof a==="function"&&(a=a(b));a&&c.instance.selectById(g,b);l(b,c);return!1}},i=function(){$("#kmltree-balloon-iframe").remove();for(var a=0;a<c.length;a++){var b=$(c[a].api.opts.element);b.find(".kmltree-selected").length+b.find(".KmlNetworkLink.kmltree-breadcrumb:not(.loaded)").length===
1&&b.find(".kmltree-cursor-2").length===0&&c[a].instance.clearSelection()}};that._clearEverythingButMe=function(a){for(var b=0;b<c.length;b++)c[b].instance!==a&&($(c[b].api.opts.element).find(".kmltree-selected").length||$(c[b].api.opts.element).find(".kmltree-breadcrumb").length)&&c[b].instance.clearSelection()};var j=function(a,b){if(!a)return!1;if(a.getUrl()===b)return!0;if(a.getElementByUrl(b))return!0},f=function(a){var a=a.getUrl(),f=a.split("#")[0],f=f.replace(/cachebuster=\d+/,"");f.indexOf("?")===
f.length-1&&(f=f.replace("?",""));if(b[f])return b[f];for(var g=0;g<c.length;g++)if(j(c[g].instance.kmlObject,a))return b[f]=c[g],c[g];for(g=0;g<c.length;g++)for(var e=c[g].api.docs,i=0;i<e.length;i++)if(j(e[i],a))return b[f]=c[g],c[g];return!1};that.getOwner=function(a){return(a=f(a))?a.instance:!1};var l=function(b,g){$(window).unbind("message.kmlTreeIframeEvents");var c,g=g.instance?g.instance:g,i=g.api?g.api:a(g);c=i.opts.displayEnhancedContent;typeof c==="function"&&(c=c(b));if(c)var h=b.getBalloonHtmlUnsafe(),
j=b.getBalloonHtml(),j=$.trim(j.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,"")),j=j!=$.trim(h);if(c&&j){c=e.createHtmlDivBalloon("");var l=document.createElement("iframe");l.setAttribute("src",i.opts.iframeSandbox);l.setAttribute("frameBorder","0");l.setAttribute("id","kmltree-balloon-iframe");j=document.createElement("div");$(j).append(l);$(l).one("load",function(){$(window).bind("message.kmlTreeIframeEvents",{window:l.contentWindow},function(a){var b=a.originalEvent;if(b.source===
a.data.window){var a=e.getBalloon(),c=a.getFeature();if($("#kmltree-balloon-iframe").length&&!(!b.data.match(/width/)&&!b.data.match(/unknownIframeDimensions/)||a.getType()!=="GEHtmlDivBalloon")){var g=f(c),b=JSON.parse(b.data);if(b.unknownIframeDimensions)b=g.api.opts.unknownIframeDimensionsDefault,typeof b==="function"&&(b=b(c));var i=$("#kmltree-balloon-iframe");a.setMinWidth(b.width);a.setMaxWidth(b.width+b.width*0.1);a.setMinHeight(b.height);a.setMaxHeight(b.height+b.height*0.1);i.height(b.height);
i.width(b.width);$(g.instance).trigger("balloonopen",[a,c])}}});this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(h),callback:Base64.encode(i.opts.sandboxedBalloonCallback.toString())}),"*")});c.setContentDiv(j)}else{c=e.createFeatureBalloon("");var A=function(a){google.earth.removeEventListener(e,"balloonopening",A);setTimeout(function(){$(g).trigger("balloonopen",[a.getBalloon(),a.getFeature()])},1)};google.earth.addEventListener(e,"balloonopening",A)}c.setFeature(b);e.setBalloon(c)};
that._openBalloon=l;return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(h){for(var c="",e,b,a,g,i,j,f=0,h=Base64._utf8_encode(h);f<h.length;)e=h.charCodeAt(f++),b=h.charCodeAt(f++),a=h.charCodeAt(f++),g=e>>2,e=(e&3)<<4|b>>4,i=(b&15)<<2|a>>6,j=a&63,isNaN(b)?i=j=64:isNaN(a)&&(j=64),c=c+this._keyStr.charAt(g)+this._keyStr.charAt(e)+this._keyStr.charAt(i)+this._keyStr.charAt(j);return c},decode:function(h){for(var c="",e,b,a,g,i,j=0,h=h.replace(/[^A-Za-z0-9\+\/\=]/g,
"");j<h.length;)e=this._keyStr.indexOf(h.charAt(j++)),b=this._keyStr.indexOf(h.charAt(j++)),g=this._keyStr.indexOf(h.charAt(j++)),i=this._keyStr.indexOf(h.charAt(j++)),e=e<<2|b>>4,b=(b&15)<<4|g>>2,a=(g&3)<<6|i,c+=String.fromCharCode(e),g!=64&&(c+=String.fromCharCode(b)),i!=64&&(c+=String.fromCharCode(a));return c=Base64._utf8_decode(c)},_utf8_encode:function(h){for(var h=h.replace(/\r\n/g,"\n"),c="",e=0;e<h.length;e++){var b=h.charCodeAt(e);b<128?c+=String.fromCharCode(b):(b>127&&b<2048?c+=String.fromCharCode(b>>
6|192):(c+=String.fromCharCode(b>>12|224),c+=String.fromCharCode(b>>6&63|128)),c+=String.fromCharCode(b&63|128))}return c},_utf8_decode:function(h){for(var c="",e=0,b=c1=c2=0;e<h.length;)b=h.charCodeAt(e),b<128?(c+=String.fromCharCode(b),e++):b>191&&b<224?(c2=h.charCodeAt(e+1),c+=String.fromCharCode((b&31)<<6|c2&63),e+=2):(c2=h.charCodeAt(e+1),c3=h.charCodeAt(e+2),c+=String.fromCharCode((b&15)<<12|(c2&63)<<6|c3&63),e+=3);return c}};
(function(){var h={};this.tmpl=function e(b,a){var g=!/\W/.test(b)?h[b]=h[b]||e(document.getElementById(b).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+b.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return a?g(a):g}})();
kmldom=function(){return function(h){if(window.ActiveXObject&&window.GetObject){var c=new ActiveXObject("Microsoft.XMLDOM");c.loadXML(h);return jQuery(c)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(h,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function h(b,a){var c=/^(.*)\//;return b.authority&&!b.path?"/"+a:b.getPath().match(c)[0]+a}function c(b){if(!b)return"";b=b.replace(/\/\.\//g,"/");for(b=b.replace(/\/\.$/,"/");b.match(e);)b=b.replace(e,"/");for(b=b.replace(/\/([^\/]*)\/\.\.$/,"/");b.match(/\/\.\.\//);)b=b.replace(/\/\.\.\//,"/");return b}var e=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(b){b||(b="");var b=b.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/),a=b[1]||null,c=b[2]||null,e=
b[3]||null,h=b[4]||null,f=b[5]||null;this.getScheme=function(){return a};this.setScheme=function(b){a=b};this.getAuthority=function(){return c};this.setAuthority=function(a){c=a};this.getPath=function(){return e};this.setPath=function(a){e=a};this.getQuery=function(){return h};this.setQuery=function(a){h=a};this.getFragment=function(){return f};this.setFragment=function(a){f=a}};URI.prototype.toString=function(){var b="";this.getScheme()&&(b+=this.getScheme()+":");this.getAuthority()&&(b+="//"+this.getAuthority());
this.getPath()&&(b+=this.getPath());this.getQuery()&&(b+="?"+this.getQuery());this.getFragment()&&(b+="#"+this.getFragment());return b};URI.prototype.resolve=function(b){var a=new URI;this.getScheme()?(a.setScheme(this.getScheme()),a.setAuthority(this.getAuthority()),a.setPath(c(this.getPath())),a.setQuery(this.getQuery())):(this.getAuthority()?(a.setAuthority(this.getAuthority()),a.setPath(c(this.getPath())),a.setQuery(this.getQuery())):(this.getPath()?(this.getPath().charAt(0)==="/"?a.setPath(c(this.getPath())):
(a.setPath(h(b,this.getPath())),a.setPath(c(a.getPath()))),a.setQuery(this.getQuery())):(a.setPath(b.getPath()),this.getQuery()?a.setQuery(this.getQuery()):a.setQuery(b.getQuery())),a.setAuthority(b.getAuthority())),a.setScheme(b.getScheme()));a.setFragment(this.getFragment());return a};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(b,a){var c=new URIQuery;if(a)c.separator=
a;c.addStringParams(b);return c};URIQuery.prototype.addStringParams=function(b){for(var b=b.split(this.separator),a,c,e=0;e<b.length;e++)a=b[e].split("=",2),c=a[0].replace(/\+/g," "),a=a[1].replace(/\+/g," "),this.params.hasOwnProperty(c)||(this.params[c]=[]),this.params[c].push(a)};URIQuery.prototype.getParam=function(b){if(this.params.hasOwnProperty(b))return this.params[b][0];return null};URIQuery.prototype.toString=function(){var b=[],a;a=this.params;var c=[],e;for(e in a)a.hasOwnProperty(e)&&
c.push(e);a=c.sort();for(c=0;c<a.length;c++)for(e=0;e<this.params[a[c]].length;e++)b.push(a[c].replace(/ /g,"+")+"="+this.params[a[c]][e].replace(/ /g,"+"));return b.join(this.separator)}})();
var kmltree=function(){function h(a){var b=document.createElement("a");b.href=a;return b.href}var c=function(a){if(a.success&&a.error&&a.tree)this.queue=[],this.opts=a;else throw"missing required option";};c.prototype.add=function(a,b){this.queue.push({node:a,callback:b,loaded:!1,errors:!1})};c.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var a=0;a<this.queue.length;a++){var b=this.queue[a];b.node.data("queueItem",b);if(!b.loaded&&!b.loading){var c=this;$(b.node).bind("loaded",
function(a,b,e){c.nodeLoadedCallback(a,b,e)});this.opts.tree.openNetworkLink(b.node);b.loading=!0}}};c.prototype.nodeLoadedCallback=function(a,b){var c=b.data("queueItem");if(c.loaded===!0)throw"event listener fired twice for "+b.find(">span.name").text();c.loaded=!0;c.loading=!1;$(b).unbind("loaded");c.callback(b);this.execute();this.finish(c)};c.prototype.finish=function(){for(var a=!0,b=!0,c=0;c<this.queue.length;c++)a=a&&this.queue[c].loaded,b=b&&!this.queue[c].errors;a&&(b?this.opts.success(this.queue):
this.opts.error(this.queue),this.destroy())};c.prototype.destroy=function(){for(var a=0;a<this.queue.length;a++)this.queue[a].node.unbind("load");this.queue=[]};var e=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= classname %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
b={refreshWithState:!0,bustCache:!1,restoreState:!1,whitelist:[],supportItemIcon:!1,loadingMsg:"Loading data",setExtent:!1,displayDocumentRoot:"auto",displayEnhancedContent:!1,iframeSandbox:"http://kmltree.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){},selectable:function(){return!1},multipleSelect:!1,classname:function(){return""}};return function(a){function g(d){for(var a=0;a<t.length;a++)if($(t[a].node)[0]===$(d)[0])return a;
return-1}function i(d,a){g(d,a)===-1&&t.push({node:d,kmlObject:a})}function j(d,a){var b=g(d,a);if(b===-1)throw"removeSelectData error";else t.splice(b,1)}var f={},l=0,s={};f.lookupTable=s;f.kmlObject=null;var z=[],a=jQuery.extend({},b,a),k=a.gex.pluginInstance,M=!1,m={},t=[];f.url=a.url;parseFloat(k.getApiVersion())<1.005&&alert("kmltree requires a google earth plugin version >= 1.005");if(!a.url||!a.gex||!a.element||!a.mapElement)throw"kmltree requires options url, gex, mapElement & element";a.element=
$(a.element);a.element.attr("id")||(a.element.attr("id","kml-tree"+(new Date).getTime()),a.element.attr("UNSELECTABLE","on"));a.restoreState&&$(window).unload(function(){f.destroy()});a.element.css("position")!=="absolute"&&$(a.element).css({position:"relative"});var o=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),A=o[0].style.backgroundSize!==
void 0||o[0].style.MozBackgroundSize!==void 0||o[0].style.oBackgroundSize!==void 0||o[0].style.khtmlBackgroundSize!==void 0||o[0].style.webkitBackgroundSize!==void 0,N=function(d,b,c){var f={name:d.getName(),id:"kml"+(c?c.replace(/\W/g,"-"):"")+b.replace(/\W/g,"-")};google.earth.executeBatch(k,function(){a.gex.dom.walk({visitCallback:function(d){var b=d.current;if(!b.children)b.children=[];var c=this.getName(),p;p=b.id;key=c?c.replace(/\W/g,"-"):"blank";p+=key;for(var u=0;s[p];)u++,p+=u;s[p]=this;
var f=this.getSnippet();if(!f||f==="empty")f=!1;var u=this.getType(),e=!1;if(u==="KmlPlacemark"){var B=this.getGeometry();B&&(e=B.getType())}var g=this.getComputedStyle(),h=a.selectable;typeof h==="function"&&(h=h(this));var h=h&&this.getId(),c=c||"&nbsp;",B=!!this.getVisibility(),i=this.getOpen(),j=this.getDescription(),k="check";if(g=g.getListStyle())switch(g.getListItemType()){case 5:k="radioFolder";break;case 2:k="checkOffOnly";break;case 3:k="checkHideChildren"}g=k;k=!1;A&&this.getType()==="KmlPlacemark"&&
this.getGeometry()&&this.getGeometry().getType()==="KmlPoint"&&(k=this.getComputedStyle().getIconStyle().getIcon().getHref());a.supportItemIcon&&(k=(k=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?k:!1);p={renderOptions:C,name:c,visible:B,type:u,open:i,id:p,description:j,snippet:f,select:h,listItemType:g,customIcon:k,classname:a.classname(this),children:[],alwaysRenderNodes:!1,kmlId:this.getId().replace(/\W/g,
"-"),geoType:e};b.children.push(p);p.listItemType!=="checkHideChildren"?d.child=p:d.walkChildren=!1},rootObject:d,rootContext:f})});return f},O=function(d){if(f.kmlObject)throw"KML already loaded";R();var b=h(a.url);if(d||a.bustCache)d=(new Date).getTime(),b=b.indexOf("?")===-1?b+"?cachebuster="+d:b+"&cachebuster="+d;google.earth.fetchKml(k,b,function(d){M||S(d,b,a.url)})};f.load=O;f.refresh=function(){if(a.refreshWithState)f.previousState=H();T();s=null;s={};k.setBalloon(null);O(!0)};var G=function(d){return a.element.find("."+
d.replace(/\W/g,"-"))};f.getNodesById=G;f.expandParentsOf=function(d){d=$(d);for(d=d.parent().parent();!d.hasClass("kmltree")&&!d.find(">ul:visible").length;)d.addClass("open"),d=d.parent().parent()};var P=function(d,a,b){d=G(d);if(d.length)return d=$(d[0]),q(!0,!0),w(d,a||n(d),b),!0;else if(d=U(a))if(d=$(d),d.is(":visible"))return q(!0,!0),d.addClass("kmltree-breadcrumb"),b||D(d,a),!0;else I(d),d.addClass("kmltree-breadcrumb"),b||D(parent,a);else return q(),!1};f.selectById=P;var Q=function(d){d=
d.getParentNode();switch(d.getType()){case "KmlNetworkLink":return d;case "GEGlobe":return!1;default:return Q(d)}},U=function(d,b){var c=a.element.attr("id");b||(b=[],$("#"+c+" li.KmlNetworkLink").each(function(){$(this).hasClass("loaded")||b.push([this,n(this)])}));c=Q(d);if(c===!1)return!1;else{c.getLink().getHref();for(var f=0;f<b.length;f++){var e=b[f][1].getLink().getHref();if(c.getLink().getHref()===e)return b[f][0]}return U(c,b)}},w=function(d,a,b){a||(a=n(d));var d=$(d),c=$(d).is(":visible");
x(d,!0);d.addClass("kmltree-selected");r(d,"selected",!0);c||I(d);b?i(d,a):(kmltreeManager._clearEverythingButMe(f),D(d,a))};f.selectNode=w;var V=function(d,a){d.each(function(b){w(this,null,!!a||!a&&b!==d.length-1)})};f.selectNodes=V;var X=function(d,a){d.each(function(b){W(this,null,!!a||!a&&b!==d.length-1)})};f.deselectNodes=X;var W=function(d,a,b){a||(a=n(d));d=$(d);d.removeClass("kmltree-selected");r(d,"selected",!1);b?j(d,a):ba(d,a)},D=function(d,a){d&&a?i(d,a):t=[];setTimeout(function(){$(f).trigger("select",
[t])},1)},ba=function(d,a){j(d,a);setTimeout(function(){$(f).trigger("select",[t])},1)},I=function(d){d=$(d);d=d.parent().parent();d.addClass("kmltree-breadcrumb");return d.is(":visible")?d:I(d)},q=function(d,b){t=[];var c=$("#"+a.element.attr("id")),f=c.find(".kmltree-selected").removeClass("kmltree-selected");c.find(".kmltree-breadcrumb").removeClass("kmltree-breadcrumb");c.find(".kmltree-cursor-1").removeClass("kmltree-cursor-1");c.find(".kmltree-cursor-2").removeClass("kmltree-cursor-2");f.length&&
f.each(function(){r($(this),"selected",!1)});b||D(null,null);k.getBalloon()&&!d&&k.setBalloon(null)};f.clearSelection=function(){return q()};var R=function(d){E();var d=d||a.loadingMsg,d=$('<div class="kmltree-loading"><span>'+d+"</span></div>"),b=a.element.height();b!==0&&d.height(b);a.element.append(d)};f.showLoading=R;var E=function(){a.element.find(".kmltree-loading").remove()};f.hideLoading=E;var S=function(d,b,u){m={};if(d){l=0;f.kmlObject=d;z.push(d);f.kmlObject.setVisibility(!0);var e=N(d,
u),g;if(a.displayDocumentRoot===!1)g=e.children[0].children;else if(a.displayDocumentRoot===!0)g=e.children[0];else{g=e.children[0].children;for(var h=0,i=!1;h<g.length&&i===!1;)i=g[h].type==="KmlPlacemark",h++;g=i?e.children[0]:e.children[0].children}g=C(g);a.element.find("div.kmltree").remove();a.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',e.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',g,"</ul></div>"].join(""));
k.getFeatures().appendChild(d);if(!f.previousState&&a.restoreState&&window.localStorage)f.previousState=ca();e=new c({success:function(){E();if(a.setExtent){var b=null,c=$(a.mapElement);c.length&&(b=c.width()/c.height());a.gex.util.flyToObject(d,{boundsFallback:!0,aspectRatio:b});a.setExtent=!1}$(f).trigger("kmlLoaded",[d])},error:function(){E();$(f).trigger("kmlLoadError",[d])},tree:f});f.previousState?Y(f.previousState,e):J(e,$("#"+a.element.attr("id")))}else l===0?(l++,setTimeout(function(){jQuery.ajax({url:b,
success:function(){f.load(!0)},error:function(){S(d,b,u)}})},100)):setTimeout(function(){a.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(f).trigger("kmlLoadError",[d])},0)},Y=function(d,b){for(var c in d){var f=$("#"+c);if(f.length===1){for(var e in d[c])f.toggleClass(e,d[c][e].value),r(f,e,d[c][e].value),e===
"visible"&&n(f).setVisibility(d[c][e].value);delete d[c]}}$("#"+a.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var a=$(this);!a.hasClass("checkHideChildren")&&!a.hasClass("loading")&&!a.hasClass("loaded")&&!a.hasClass("error")&&b.add(a,function(){Y(d,b)})});b.execute()},J=function(d,a){a.find("li.KmlNetworkLink.open").each(function(){var a=$(this);!a.hasClass("checkHideChildren")&&!a.hasClass("loading")&&!a.hasClass("loaded")&&(a.removeClass("open"),d.add(a,function(b){b.addClass("open");
r(b,"open",a.hasClass("open"));J(d,b)}))});d.execute()},C=function(d){if(jQuery.isArray(d)){for(var a=[],b=0;b<d.length;b++)a.push(e(jQuery.extend({},Z,d[b])));return a.join("")}else return e(jQuery.extend({},Z,d))},Z={renderOptions:C},da=function(){$(".KmlNetworkLink").each(function(){var d=n($(this));d&&d.getParentNode()&&a.gex.dom.removeObject(n($(this)))})},T=function(){da();f.kmlObject&&f.kmlObject.getParentNode()&&a.gex.dom.removeObject(f.kmlObject);f.kmlObject=null;z=[]},ca=function(){var d=
localStorage.getItem("kmltree-("+a.url+")");return d?JSON.parse(d):!1};f.destroy=function(){M=!0;kmltreeManager.remove(f);if(a.restoreState&&window.localStorage){var d=JSON.stringify(H());localStorage.setItem("kmltree-("+a.url+")",d)}T();s=null;s={};if(d=k.getBalloon())if(d=d.getFeature())(d=kmltreeManager.getOwner(d))&&d.instance===f&&k.setBalloon(null);k.setBalloon(null);d=a.element.attr("id");$("#"+d+" li > span.name").die();$("#"+d+" li").die();$("#"+d+" li > .expander").die();$(f).die();$(f).unbind();
$("#kmltree-balloon-iframe").remove();a.element.html("")};var n=function(d){d=$(d);return d.length?s[d.attr("id")]:!1};f.lookup=n;var y=function(d,a){if(a){if(!d.hasClass("checkOffOnly"))if(d.hasClass("radioFolder")){if(!d.find(">ul>li.visible").length){var b=d.find(">ul>li");b.length&&(v($(b[0]),!0),y($(b[0]),!0))}}else d.find(">ul>li").each(function(){var d=$(this);d.hasClass("checkOffOnly")||(v(d,!0),y(d,!0))})}else d.find("li").each(function(){v($(this),!1)})},K=function(d,a){var b=d.parent().parent();
if(!b.hasClass("kmltree"))if(a){var c=b.parent().parent();c.hasClass("radioFolder")&&c.find(">ul>li.visible").each(function(){if(this!==b[0]){var d=$(this);v(d,!1);y(d,!1)}});b.hasClass("visible")||(v(b,!0),K(b,!0))}else b.find(">ul>li.visible").length===0&&(v(b,!1),K(b,!1))},x=function(d,a){if(!d.hasClass("checkOffOnly")||!a){var b=d.parent().parent();b.hasClass("radioFolder")&&b.find(">ul>li.visible").each(function(){v($(this),!1);y($(this),!1)});v(d,a);(!a||!d.find("li.visible").length)&&y(d,a);
K(d,a)}},v=function(d,a){d=$(d);d.hasClass("visible")!==a&&(r(d,"visible",a),n(d).setVisibility(a),d.toggleClass("visible",a))},r=function(d,a,b){d=d.attr("id");m[d]||(m[d]={});d=m[d];d[a]?d[a].value=b:d[a]={original:!b,value:b}},H=function(){for(var a in m){for(var b in m[a])m[a][b].original===m[a][b].value&&delete m[a][b];var c=0;for(b in m[a])m[a].hasOwnProperty(b)&&c++;c===0&&delete m[a]}return m};f.getState=H;f.openNetworkLink=function(d){if(d.find("> ul").length)throw"networklink already loaded";
else{var b=n(d),c=b.getLink();if(c)var e=c=c.getHref();else{var g=kmldom(b.getKml()).find("Url>href");if(g.length)e=c=g.text();else{d.addClass("error");$(d).trigger("loaded",[d,!1]);d.removeClass("open");r(d,"open",!1);return}}g=new URI(c);if(g.getAuthority()===null){window.nl=b;var h=b.getOwnerDocument();if((window.doc=h)&&h.getUrl())if(h=h.getUrl())var h=new URI(h),i=g.resolve(h);i?c=i.toString():alert("Could not resolve relative link in kml ,document. You may need to upgrade to the ,latest Google Earth Plugin.")}a.bustCache&&
(i=(new Date).getTime(),c=c.indexOf("?")===-1?c+"?cachebuster="+i:c+"&cachebuster="+i);d.addClass("loading");google.earth.fetchKml(k,c,function(a){if(a){k.getFeatures().appendChild(a);a.setVisibility(b.getVisibility());var g=b.getName();b.getParentNode().getFeatures().removeChild(b);g=N(a,e,g);g=C(g.children[0].children);d.append("<ul>"+g+"</ul>");d.addClass("open");r(d,"open",d.hasClass("open"));d.removeClass("loading");d.addClass("loaded");s[d.attr("id")]=a;z.push(a);$(d).attr("data-rememberedLink",
F.length.toString());$(d).data("original-networklink",b);F.push(b);$(d).trigger("loaded",[d,a]);$(f).trigger("networklinkload",[d,a,b])}else alert("Error loading "+c),d.addClass("error"),$(f).trigger("kmlLoadError",[a]),d.removeClass("open")})}};var F=[];f.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&F.length>=a?F[a]:!1};var aa=function(a,b){var e=new c({success:function(c){b&&b(a,c)},error:function(){},tree:f});e.add(a,function(b){b.addClass("open");r(b,"open",a.hasClass("open"));
J(e,b)});e.execute()},o=a.element.attr("id");$("#"+o+" li > span.name").live("click",function(b){b.stopPropagation();var c=!1,e=$(this).parent(),g=n(e);e.hasClass("error")&&e.hasClass("KmlNetworkLink")&&(g.getLink()&&g.getLink().getHref()?alert("Could not load NetworkLink with url "+g.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found"));if(e.hasClass("select"))if(a.multipleSelect&&b.metaKey)e.hasClass("kmltree-selected")?($(".kmltree-cursor-1").removeClass("kmltree-cursor-1"),
e.removeClass("kmltree-cursor-1"),W(e,g)):($(".kmltree-cursor-1").removeClass("kmltree-cursor-1"),$(".kmltree-cursor-2").removeClass("kmltree-cursor-2"),e.addClass("kmltree-cursor-1"),w(e,g)),kmltreeManager.pauseListeners(function(){k.setBalloon(null)}),c=!0;else if(a.multipleSelect&&b.shiftKey)if(b=$("#"+a.element.attr("id")),selected=b.find(".kmltree-selected"),selected.length===1&&selected.addClass("kmltree-cursor-1"),b.find(".kmltree-cursor-1").length===0)q(!0,!0),w(e,g);else{c=e.parent().parent();
if(b.find(".kmltree-cursor-1").parent().parent()[0]===c[0]){c=b.find(".kmltree-cursor-2");if(c.length){var h=b.find(".kmltree-cursor-1, .kmltree-cursor-2"),i=h.first(),h=h.last();i.parent().parent().find("> ul > li");i=i.nextUntil('[id="'+h.attr("id")+'"]').andSelf().add(h);c.removeClass("kmltree-cursor-2");X(i,!0)}e.addClass("kmltree-cursor-2");h=b.find(".kmltree-cursor-1, .kmltree-cursor-2");i=h.first();h=h.last();i[0]===h[0]?b.find(".kmltree-cursor-1, .kmltree-cursor-2").removeClass("kmltree-cursor-2").removeClass("kmltree-cursor-1"):
(i.parent().parent().find("> ul > li"),i=i.nextUntil('[id="'+h.attr("id")+'"]').andSelf().add(h));V(i);kmltreeManager.pauseListeners(function(){k.setBalloon(null)})}c=!0}else q(!0,!0),w(e,g);else q(),e.addClass("kmltree-cursor-1"),(e.hasClass("hasDescription")||g.getType()==="KmlPlacemark")&&g.getType()==="KmlPlacemark"&&x(e,!0);c||(g.getType()==="KmlPlacemark"||g.getDescription())&&kmltreeManager.pauseListeners(function(){kmltreeManager._openBalloon(g,f)});$(f).trigger("click",[e[0],g])});$("#"+
o+" li").live("contextmenu",function(a){var b=$(this);b.hasClass("select")&&(b.hasClass("kmltree-selected")||(q(!0,!0),w(b)),setTimeout(function(){$(f).trigger("context",[t])},2));a.preventDefault();return!1});a.element.click(function(a){var b=$(a.target);a.target===this||b.hasClass("toggle")&&b.hasClass("select");(b.find(".kmltree-selected").length||b.find(".kmltree-breadcrumb").length)&&q()});$("#"+o+" li > .expander").live("click",function(){var a=$(this).parent(),b=a.hasClass("open");a.hasClass("KmlNetworkLink")&&
!a.hasClass("loaded")&&!a.hasClass("loading")?aa(a,function(c){c.hasClass("kmltree-breadcrumb")&&(b?a.find(".kmltree-selected").length&&a.addClass("kmltree-breadcrumb"):a.removeClass("kmltree-breadcrumb"),c=k.getBalloon().getFeature(),P(c.getId(),c,!0))}):(a.toggleClass("open"),r(a,"open",a.hasClass("open")),b?a.find(".kmltree-selected").length&&a.addClass("kmltree-breadcrumb"):a.removeClass("kmltree-breadcrumb"))});$("#"+o+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");
!b&&a.hasClass("kmltree-selected")&&q();!b&&k.getBalloon()&&k.setBalloon(null);if(!a.hasClass("checkOffOnly")||!b)a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")?(aa(a),$(a).bind("loaded",function(a,b){x(b,!0);b.removeClass("open")})):x(a,b),$(f).trigger("toggleItem",[a,b,n(a)])});$("#"+o+" li").live("dblclick",function(b){b.stopPropagation();var c=$(b.target),b=c.parent();if(!c.hasClass("expander")&&!c.hasClass("toggler")&&
!b.hasClass("expander")&&!b.hasClass("toggler")){var c=$(this),e=n(c);if(c.hasClass("error"))e.getLink()&&e.getLink().getHref()?alert("Could not load NetworkLink with url "+e.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{x(c,!0);if(e.getType()=="KmlTour")k.getTourPlayer().setTour(e);else{var g=null,h=$(a.mapElement);h.length&&(g=h.width()/h.height());a.gex.util.flyToObject(e,{boundsFallback:b.find("li").length<1E3,aspectRatio:g})}$(f).trigger("dblclick",
[c,e])}}});var L=!1;google.earth.addEventListener(k.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe"&&b.getType()==="KmlPlacemark"){var a=b.getId(),c=G(a);c.length>=1&&!L&&(L=!0,setTimeout(function(){L=!1;var a=$(c[0]);$(f).trigger("dblclick",[a,b])},200))}}});f.removeEventListener=f.detachEvent=function(){};kmltreeManager.register(f,{opts:a,docs:z});return f}}(),enableGoogleLayersControl=function(){var h=function(c,e,b){if((c=c.getId())&&c.match(/^LAYER/))b.getLayerRoot().enableLayerById(b[c],
e);else{var a=b.getOptions();switch(c){case "SUN":b.getSun().setVisibility(e);break;case "NAVIGATION_CONTROLS":c=b.VISIBILITY_SHOW;if(!e)c=b.VISIBILITY_HIDE;b.getNavigationControl().setVisibility(c);break;case "STATUS_BAR":a.setStatusBarVisibility(e);break;case "OVERVIEW_MAP":a.setOverviewMapVisibility(e);break;case "SCALE_LEGEND":a.setScaleLegendVisibility(e);break;case "ATMOSPHERE":a.setAtmosphereVisibility(e);break;case "HISTORICAL_IMAGERY":b.getTime().setHistoricalImageryEnabled(e);break;case "GRID":a.setGridVisibility(e);
break;case "STREET_VIEW":b.getNavigationControl().setStreetViewEnabled(e)}}};return function(c,e){(!c||!e)&&alert("Must call enableGoogleLayersControl with both tree and ge options!");$(c).bind("toggleItem",function(b,a,c,i){h(i,c,e)});$(c).bind("kmlLoaded",function(b,a){for(var c=a.getFeatures().getChildNodes(),i=c.getLength(),j=0;j<i;j++){var f=c.item(j);h(f,f.getVisibility(),e)}})}}();
